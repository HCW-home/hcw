import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { BehaviorSubject, Observable, firstValueFrom, from, switchMap, tap } from 'rxjs';
import { environment } from '../../../environments/environment';
import { User, LoginRequest, LoginResponse, RegisterRequest, MagicLinkRequest, MagicLinkVerify, TokenAuthRequest, TokenAuthResponse } from '../models/user.model';
import { StorageService } from './storage.service';

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private apiUrl = environment.apiUrl;
  private currentUserSubject = new BehaviorSubject<User | null>(null);
  public currentUser$ = this.currentUserSubject.asObservable();
  private isAuthenticatedSubject = new BehaviorSubject<boolean>(false);
  public isAuthenticated$ = this.isAuthenticatedSubject.asObservable();
  public authReady: Promise<void>;

  constructor(
    private http: HttpClient,
    private storage: StorageService
  ) {
    this.authReady = this.checkAuthStatus();
  }

  private async checkAuthStatus(): Promise<void> {
    const token = await this.storage.get('access_token');
    if (token) {
      this.isAuthenticatedSubject.next(true);
      try {
        await firstValueFrom(this.getCurrentUser());
      } catch {
        this.isAuthenticatedSubject.next(false);
        await this.storage.remove('access_token');
        await this.storage.remove('refresh_token');
      }
    }
  }

  login(credentials: LoginRequest): Observable<LoginResponse> {
    return this.http.post<LoginResponse>(`${this.apiUrl}/auth/login/`, credentials)
      .pipe(
        switchMap(async (response) => {
          if (response.access) {
            await this.storage.set('access_token', response.access);
            await this.storage.set('refresh_token', response.refresh);
            this.isAuthenticatedSubject.next(true);
            if (response.user) {
              this.currentUserSubject.next(response.user);
            }
          }
          return response;
        })
      );
  }

  register(data: RegisterRequest): Observable<any> {
    return this.http.post(`${this.apiUrl}/auth/registration/`, data);
  }

  forgotPassword(data: { email: string }): Observable<any> {
    return this.http.post(`${this.apiUrl}/auth/password/reset/`, data);
  }

  resetPasswordConfirm(data: {
    uid: string;
    token: string;
    new_password1: string;
    new_password2: string;
  }): Observable<{ detail: string }> {
    return this.http.post<{ detail: string }>(`${this.apiUrl}/auth/password/reset/confirm/`, data);
  }

  loginWithToken(data: TokenAuthRequest): Observable<TokenAuthResponse> {
    return this.http.post<TokenAuthResponse>(`${this.apiUrl}/auth/token/`, data)
      .pipe(
        switchMap(async (response) => {
          if (response.access && response.refresh) {
            await this.storage.set('access_token', response.access);
            await this.storage.set('refresh_token', response.refresh);
            this.isAuthenticatedSubject.next(true);
          }
          return response;
        })
      );
  }

  getCurrentUser(): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/auth/user/`)
      .pipe(
        tap(user => this.currentUserSubject.next(user))
      );
  }

  uploadProfilePicture(file: File): Observable<User> {
    const formData = new FormData();
    formData.append('picture', file);
    return this.http.patch<User>(`${this.apiUrl}/auth/user/`, formData)
      .pipe(
        tap(user => this.currentUserSubject.next(user))
      );
  }

  updateProfile(data: Partial<User>): Observable<User> {
    return this.http.patch<User>(`${this.apiUrl}/auth/user/`, data)
      .pipe(
        tap(user => this.currentUserSubject.next(user))
      );
  }

  get currentUserValue(): User | null {
    return this.currentUserSubject.value;
  }

  get isAuthenticatedValue(): boolean {
    return this.isAuthenticatedSubject.value;
  }

  async logout() {
    await this.storage.remove('access_token');
    await this.storage.remove('refresh_token');
    this.currentUserSubject.next(null);
    this.isAuthenticatedSubject.next(false);
  }

  async getToken(): Promise<string | null> {
    return await this.storage.get('access_token');
  }

  async refreshToken(): Promise<Observable<any>> {
    const refresh = await this.storage.get('refresh_token');
    return this.http.post(`${this.apiUrl}/auth/token/refresh/`, { refresh })
      .pipe(
        tap(async (response: any) => {
          if (response.access) {
            await this.storage.set('access_token', response.access);
          }
        })
      );
  }
}
