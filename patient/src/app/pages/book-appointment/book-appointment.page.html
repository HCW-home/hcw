<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Request Consultation</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    <ion-progress-bar [value]="getProgressPercentage() / 100" color="primary"></ion-progress-bar>
  </ion-toolbar>
</ion-header>

<ion-content class="book-appointment-content">
  <div class="step-header">
    <ion-text class="step-indicator" color="medium">Step {{ currentStep }} of {{ totalSteps }}</ion-text>
    <ion-text class="step-title">{{ getStepTitle() }}</ion-text>
  </div>

  @if (selectedDoctor && currentStep === 1) {
    <ion-card class="doctor-info-card">
      <ion-card-content>
        <div class="doctor-info">
          <ion-avatar>
            <img [src]="selectedDoctor.picture || 'assets/images/default-doctor.svg'" [alt]="selectedDoctor.first_name">
          </ion-avatar>
          <div class="doctor-details">
            <ion-text class="doctor-name">Dr. {{ selectedDoctor.first_name }} {{ selectedDoctor.last_name }}</ion-text>
            @if (selectedDoctor.specialities && selectedDoctor.specialities.length > 0) {
              <ion-text class="doctor-specialty" color="medium">{{ selectedDoctor.specialities[0].name }}</ion-text>
            }
            @if (selectedDoctor.consultation_fee) {
              <ion-text class="consultation-fee" color="primary">${{ selectedDoctor.consultation_fee }}</ion-text>
            }
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  }

  <div class="step-content">
    @switch (currentStep) {
      @case (1) {
        <ion-card class="beneficiary-card">
          <ion-card-content>
            <app-user-search-select
              label="Who is this consultation for?"
              placeholder="Search for a family member..."
              [selectedUser]="selectedBeneficiary"
              (userSelected)="onBeneficiarySelected($event)">
            </app-user-search-select>
            @if (!selectedBeneficiary) {
              <ion-text class="helper-text" color="medium">
                Leave empty if the consultation is for yourself
              </ion-text>
            }
          </ion-card-content>
        </ion-card>

        <div class="appointment-types">
          @for (type of appointmentTypes; track type.value) {
            <ion-card
              class="type-card"
              [class.selected]="appointmentData.appointmentType === type.value"
              (click)="appointmentData.appointmentType = type.value">
              <ion-card-content>
                <ion-icon [name]="type.icon" color="primary"></ion-icon>
                <ion-text class="type-label">{{ type.label }}</ion-text>
                <ion-text class="type-description" color="medium">{{ type.description }}</ion-text>
                @if (appointmentData.appointmentType === type.value) {
                  <ion-icon name="checkmark-circle" color="primary" class="selected-icon"></ion-icon>
                }
              </ion-card-content>
            </ion-card>
          }
        </div>
      }

      @case (2) {
        <ion-card class="schedule-toggle-card">
          <ion-card-content>
            <ion-item lines="none">
              <ion-label>
                <h2>Schedule a specific time?</h2>
                <p>You can request a specific appointment time or let us contact you to schedule</p>
              </ion-label>
              <ion-toggle
                slot="end"
                [checked]="scheduleAppointment"
                (ionChange)="onScheduleToggleChange($event)">
              </ion-toggle>
            </ion-item>
          </ion-card-content>
        </ion-card>

        @if (scheduleAppointment) {
          <ion-card class="date-time-card">
            <ion-card-content>
              <ion-text class="section-label">Select Date</ion-text>
              <ion-datetime
                presentation="date"
                [min]="minDate"
                [max]="maxDate"
                [(ngModel)]="selectedDate"
                (ionChange)="onDateChange($event)"
                class="custom-datetime">
              </ion-datetime>
            </ion-card-content>
          </ion-card>

          @if (selectedDate) {
            <ion-card class="time-slots-card">
              <ion-card-content>
                <ion-text class="section-label">Available Time Slots</ion-text>
                <div class="time-slots-grid">
                  @for (slot of availableSlots; track slot.time) {
                    <div
                      class="time-slot"
                      [class.available]="slot.available"
                      [class.selected]="slot.selected"
                      [class.unavailable]="!slot.available"
                      (click)="selectTimeSlot(slot)">
                      <ion-text>{{ slot.time }}</ion-text>
                    </div>
                  }
                </div>
              </ion-card-content>
            </ion-card>
          }
        } @else {
          <ion-card class="no-schedule-card">
            <ion-card-content>
              <ion-icon name="calendar-outline" color="medium"></ion-icon>
              <ion-text color="medium">
                We will contact you to schedule an appointment after reviewing your request.
              </ion-text>
            </ion-card-content>
          </ion-card>
        }
      }

      @case (3) {
        <ion-card class="symptoms-card">
          <ion-card-content>
            <ion-text class="section-label">Select Symptoms</ion-text>
            <div class="symptoms-chips">
              @for (symptom of commonSymptoms; track symptom) {
                <ion-chip
                  [class.selected]="selectedSymptoms.includes(symptom)"
                  (click)="toggleSymptom(symptom)">
                  @if (selectedSymptoms.includes(symptom)) {
                    <ion-icon name="checkmark-circle" ></ion-icon>
                  }
                  <ion-label>{{ symptom }}</ion-label>
                </ion-chip>
              }
            </div>
          </ion-card-content>
        </ion-card>

        <ion-card class="reason-card">
          <ion-card-content>
            <ion-item lines="none">
              <ion-label position="stacked">Reason for Visit</ion-label>
              <ion-textarea
                [(ngModel)]="appointmentData.reason"
                placeholder="Please describe the main reason for your visit"
                rows="3">
              </ion-textarea>
            </ion-item>

            <ion-item lines="none">
              <ion-label position="stacked">Additional Notes (Optional)</ion-label>
              <ion-textarea
                [(ngModel)]="appointmentData.notes"
                placeholder="Any additional information for the doctor"
                rows="2">
              </ion-textarea>
            </ion-item>
          </ion-card-content>
        </ion-card>
      }

      @case (4) {
        <ion-card class="review-card">
          <ion-card-content>
            <ion-text class="review-title">Consultation Request Summary</ion-text>

            <ion-item lines="none">
              <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <ion-text class="review-label">Beneficiary</ion-text>
                <ion-text class="review-value">{{ getBeneficiaryDisplayName() }}</ion-text>
              </ion-label>
            </ion-item>

            @if (selectedDoctor) {
              <ion-item lines="none">
                <ion-icon name="medkit-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <ion-text class="review-label">Doctor</ion-text>
                  <ion-text class="review-value">Dr. {{ selectedDoctor.first_name }} {{ selectedDoctor.last_name }}</ion-text>
                </ion-label>
              </ion-item>
            }

            @if (scheduleAppointment && appointmentData.date) {
              <ion-item lines="none">
                <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <ion-text class="review-label">Preferred Date</ion-text>
                  <ion-text class="review-value">{{ formatDate(appointmentData.date) }}</ion-text>
                </ion-label>
              </ion-item>

              <ion-item lines="none">
                <ion-icon name="time-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <ion-text class="review-label">Preferred Time</ion-text>
                  <ion-text class="review-value">{{ appointmentData.time }}</ion-text>
                </ion-label>
              </ion-item>
            } @else {
              <ion-item lines="none">
                <ion-icon name="calendar-outline" slot="start" color="medium"></ion-icon>
                <ion-label>
                  <ion-text class="review-label">Appointment</ion-text>
                  <ion-text class="review-value" color="medium">To be scheduled</ion-text>
                </ion-label>
              </ion-item>
            }

            <ion-item lines="none">
              <ion-icon name="videocam-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <ion-text class="review-label">Type</ion-text>
                <ion-text class="review-value">{{ appointmentData.appointmentType === 'video' ? 'Video Consultation' : 'In-Person Visit' }}</ion-text>
              </ion-label>
            </ion-item>

            @if (selectedSymptoms.length > 0) {
              <ion-item lines="none">
                <ion-icon name="medical-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <ion-text class="review-label">Symptoms</ion-text>
                  <ion-text class="review-value">{{ selectedSymptoms.join(', ') }}</ion-text>
                </ion-label>
              </ion-item>
            }

            @if (appointmentData.reason) {
              <ion-item lines="none">
                <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <ion-text class="review-label">Reason</ion-text>
                  <ion-text class="review-value">{{ appointmentData.reason }}</ion-text>
                </ion-label>
              </ion-item>
            }

            @if (selectedDoctor && selectedDoctor.consultation_fee) {
              <ion-item lines="none" class="fee-item">
                <ion-icon name="card-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <ion-text class="review-label">Consultation Fee</ion-text>
                  <ion-text class="review-value fee-amount">${{ selectedDoctor.consultation_fee }}</ion-text>
                </ion-label>
              </ion-item>
            }
          </ion-card-content>
        </ion-card>
      }
    }
  </div>

  <div class="action-buttons">
    @if (currentStep > 1) {
      <ion-button fill="outline" (click)="previousStep()">
        <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
        Previous
      </ion-button>
    }
    <ion-button expand="block" (click)="nextStep()">
      {{ currentStep === totalSteps ? 'Submit Request' : 'Continue' }}
      @if (currentStep < totalSteps) {
        <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
      }
    </ion-button>
  </div>
</ion-content>
