<ion-header class="ion-no-border">
  <ion-toolbar>
    <div class="header-content">
      <div class="logo">
        <img src="assets/images/logo.svg" alt="HCW Logo" class="logo-img">
        <div class="logo-text-group">
          <span class="logo-text">HCW</span>
          <span class="logo-subtitle">Patient</span>
        </div>
      </div>
      <ion-buttons slot="end">
        <ion-button class="user-avatar-btn" (click)="goToProfile()">
          <div class="user-avatar">{{ getUserInitials() }}</div>
        </ion-button>
      </ion-buttons>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="home-content">
  <ion-refresher slot="fixed" (ionRefresh)="refreshData($any($event))">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="main-content">
    <div class="greeting">
      <p class="greeting-text">Welcome back,</p>
      <h1 class="greeting-name">{{ currentUser()?.first_name || 'User' }}</h1>
    </div>

    <div class="cta-section">
      <button class="cta-button" (click)="goToNewRequest()">
        <span class="cta-icon">
          <ion-icon name="add-outline"></ion-icon>
        </span>
        Request a Consultation
      </button>
    </div>

    <section class="section requests-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">My Requests</h2>
          @if (totalRequests() > 0) {
            <span class="section-badge">{{ totalRequests() }} total</span>
          }
        </div>
      </div>

      @if (isLoading()) {
        <div class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      } @else if (requests().length === 0) {
        <div class="empty-state">
          <ion-icon name="document-text-outline" class="empty-icon"></ion-icon>
          <p class="empty-text">No requests yet</p>
          <p class="empty-hint">Tap the button above to request a consultation</p>
        </div>
      } @else {
        @for (request of requests(); track request.id) {
          <div class="request-card" (click)="viewRequestDetails(request)">
            <div class="request-header">
              <div class="request-title-row">
                <h3 class="request-reason">{{ getReasonName(request) }}</h3>
                <span class="status-badge status-{{ getStatusConfig(request.status).color }}">
                  {{ getStatusConfig(request.status).label }}
                </span>
              </div>
              @if (getSpecialityName(request)) {
                <span class="request-specialty">{{ getSpecialityName(request) }}</span>
              }
            </div>

            @if (hasAppointment(request)) {
              <div class="sub-section appointment-sub">
                <div class="sub-section-header">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <span>Upcoming appointment</span>
                </div>
                <div class="appointment-content">
                  <div class="doctor-avatar">
                    {{ getDoctorName(request) ? getDoctorName(request).charAt(0) : '?' }}
                  </div>
                  <div class="appointment-details">
                    @if (getDoctorName(request)) {
                      <p class="doctor-name">{{ getDoctorName(request) }}</p>
                    }
                    <div class="appointment-meta">
                      <span class="meta-item">
                        <ion-icon name="calendar-outline"></ion-icon>
                        {{ request.appointment?.scheduled_at | date:'EEE, MMM d' }}
                      </span>
                      <span class="meta-item">
                        <ion-icon name="time-outline"></ion-icon>
                        {{ request.appointment?.scheduled_at | date:'HH:mm' }}
                      </span>
                      <span class="meta-item type-tag">
                        <ion-icon [name]="getAppointmentTypeIcon(request)"></ion-icon>
                        {{ getAppointmentTypeLabel(request) }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            }

            @if (hasConsultation(request)) {
              <div class="sub-section consultation-sub">
                <div class="sub-section-header">
                  <ion-icon name="chatbubbles-outline"></ion-icon>
                  <span>Active consultation</span>
                </div>
                <div class="consultation-content">
                  <p class="consultation-hint">Tap to view messages</p>
                </div>
              </div>
            }

            @if (isStatusRequested(request)) {
              <div class="sub-section pending-sub">
                <div class="sub-section-header">
                  <ion-icon name="hourglass-outline"></ion-icon>
                  <span>Awaiting doctor assignment</span>
                </div>
              </div>
            }

            @if (isStatusAccepted(request) && !hasAppointment(request)) {
              <div class="sub-section accepted-sub">
                <div class="sub-section-header">
                  <ion-icon name="checkmark-circle-outline"></ion-icon>
                  <span>Request accepted</span>
                </div>
                <p class="sub-hint">Appointment will be scheduled soon</p>
              </div>
            }

            @if (isStatusRefused(request)) {
              <div class="sub-section refused-sub">
                <div class="sub-section-header">
                  <ion-icon name="close-circle-outline"></ion-icon>
                  <span>Request refused</span>
                </div>
                @if (request.refused_reason) {
                  <p class="sub-hint refused-reason">{{ request.refused_reason }}</p>
                }
              </div>
            }

            <button class="card-action-btn">
              <span>View details</span>
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </button>
          </div>
        }
      }
    </section>

    <section class="section consultations-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">My Consultations</h2>
          @if (totalConsultations() > 0) {
            <span class="section-badge">{{ totalConsultations() }} total</span>
          }
        </div>
      </div>

      @if (isLoading()) {
        <div class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      } @else if (consultations().length === 0) {
        <div class="empty-state">
          <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
          <p class="empty-text">No consultations yet</p>
          <p class="empty-hint">Your consultations will appear here once created</p>
        </div>
      } @else {
        @for (consultation of consultations(); track consultation.id) {
          <div class="consultation-card" (click)="viewConsultationDetails(consultation)">
            <div class="consultation-header">
              <div class="consultation-title-row">
                <h3 class="consultation-reason">{{ getConsultationReasonName(consultation) }}</h3>
                <span class="status-badge status-{{ getConsultationStatusConfig(consultation.status).color }}">
                  {{ getConsultationStatusConfig(consultation.status).label }}
                </span>
              </div>
              @if (getConsultationDoctorName(consultation)) {
                <span class="consultation-doctor">{{ getConsultationDoctorName(consultation) }}</span>
              }
            </div>

            <div class="consultation-meta">
              <span class="meta-item">
                <ion-icon name="calendar-outline"></ion-icon>
                {{ consultation.created_at | date:'MMM d, yyyy' }}
              </span>
              @if (consultation.appointments && consultation.appointments.length > 0) {
                <span class="meta-item">
                  <ion-icon name="videocam-outline"></ion-icon>
                  {{ consultation.appointments.length }} appointment{{ consultation.appointments.length > 1 ? 's' : '' }}
                </span>
              }
            </div>

            <button class="card-action-btn">
              <span>View consultation</span>
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </button>
          </div>
        }
      }
    </section>

    <section class="section appointments-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">My Appointments</h2>
          @if (totalAppointments() > 0) {
            <span class="section-badge">{{ totalAppointments() }} total</span>
          }
        </div>
      </div>

      @if (isLoading()) {
        <div class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      } @else if (appointments().length === 0) {
        <div class="empty-state">
          <ion-icon name="calendar-outline" class="empty-icon"></ion-icon>
          <p class="empty-text">No appointments yet</p>
          <p class="empty-hint">Your scheduled appointments will appear here</p>
        </div>
      } @else {
        @for (appointment of appointments(); track appointment.id) {
          <div class="appointment-card" (click)="viewAppointmentDetails(appointment)">
            <div class="appointment-header">
              <div class="appointment-title-row">
                <div class="appointment-type-badge">
                  <ion-icon [name]="getAppointmentIcon(appointment)"></ion-icon>
                  <span>{{ getAppointmentTypeText(appointment) }}</span>
                </div>
                <span class="status-badge status-{{ getAppointmentStatusConfig(appointment.status).color }}">
                  {{ getAppointmentStatusConfig(appointment.status).label }}
                </span>
              </div>
              @if (getAppointmentDoctorName(appointment)) {
                <span class="appointment-doctor">{{ getAppointmentDoctorName(appointment) }}</span>
              }
            </div>

            <div class="appointment-meta">
              <span class="meta-item">
                <ion-icon name="calendar-outline"></ion-icon>
                {{ appointment.scheduled_at | date:'EEE, MMM d, yyyy' }}
              </span>
              <span class="meta-item">
                <ion-icon name="time-outline"></ion-icon>
                {{ appointment.scheduled_at | date:'HH:mm' }}
              </span>
            </div>

            <button class="card-action-btn">
              <span>View details</span>
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </button>
          </div>
        }
      }
    </section>
  </div>
</ion-content>
