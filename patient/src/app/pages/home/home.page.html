<ion-header class="ion-no-border">
  <ion-toolbar>
    <div class="header-content">
      <div class="logo">
        <img src="assets/images/logo.svg" alt="HCW Logo" class="logo-img">
        <span class="logo-text">{{ branding() }}</span>
      </div>
      <ion-buttons slot="end">
        <ion-button class="notification-btn" (click)="goToNotifications()">
          <ion-icon name="notifications-outline"></ion-icon>
          @if (unreadNotificationCount() > 0) {
            <span class="notification-badge">{{ unreadNotificationCount() > 9 ? '9+' : unreadNotificationCount() }}</span>
          }
        </ion-button>
        <ion-button class="user-avatar-btn" (click)="goToProfile()">
          <div class="user-avatar">
            @if (getUserPicture()) {
              <img [src]="getUserPicture()" alt="" class="avatar-image">
            } @else {
              {{ getUserInitials() }}
            }
          </div>
        </ion-button>
      </ion-buttons>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="home-content">
  <ion-refresher slot="fixed" (ionRefresh)="refreshData($any($event))">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="main-content">
    @if (nextAppointment()) {
      <div class="next-appointment-banner">
        <div class="next-appointment-icon">
          <ion-icon [name]="nextAppointment()!.type === 'online' ? 'videocam' : 'location-outline'"></ion-icon>
        </div>
        <div class="next-appointment-info">
          <span class="next-appointment-label">
            Next Appointment â€”
            <ion-icon [name]="nextAppointment()!.type === 'online' ? 'videocam-outline' : 'location-outline'"></ion-icon>
            {{ nextAppointment()!.type === 'online' ? 'Online' : 'In person' }}
          </span>
          <span class="next-appointment-date">
            {{ nextAppointment()!.scheduled_at | date:'EEEE, MMM d' }} at {{ nextAppointment()!.scheduled_at | date:'HH:mm' }}
          </span>
          @if (getNextAppointmentDoctorName()) {
            <span class="next-appointment-doctor">{{ getNextAppointmentDoctorName() }}</span>
          }
        </div>
        @if (nextAppointment()!.type === 'online') {
          <button class="join-button" (click)="joinNextAppointment()">
            <ion-icon name="videocam"></ion-icon>
            <span>Join</span>
          </button>
        } @else {
          <div class="in-person-badge">
            <ion-icon name="location-outline"></ion-icon>
            <span>In person</span>
          </div>
        }
      </div>
    }

    <section class="section requests-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">My Requests</h2>
          @if (totalRequests() > 0) {
            <span class="section-badge">{{ totalRequests() }} total</span>
          }
        </div>
      </div>

      @if (isLoading()) {
        <div class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      } @else if (requests().length === 0) {
        <div class="empty-state">
          <ion-icon name="document-text-outline" class="empty-icon"></ion-icon>
          <p class="empty-text">No pending requests yet</p>
          <button class="card-btn empty-cta" [class.card-btn-primary]="hasNoItems()" [class.card-btn-outline]="!hasNoItems()" (click)="goToNewRequest()">
            <ion-icon name="add-outline"></ion-icon>
            <span>Request a consultation</span>
          </button>
        </div>
      } @else {
        <div class="cards-grid">
          @for (request of requests(); track request.id) {
            <div class="request-card" (click)="viewRequestDetails(request)">
              <div class="card-top-row">
                <span class="status-badge status-{{ getStatusConfig(request.status).color }}">
                  {{ getStatusConfig(request.status).label }}
                </span>
                @if (request.created_at) {
                  <span class="card-date">{{ request.created_at | date:'MMM d, yyyy' }}</span>
                }
              </div>

              <h3 class="card-title">{{ getReasonName(request) }}</h3>

              @if (getSpecialityName(request)) {
                <span class="card-subtitle">{{ getSpecialityName(request) }}</span>
              }

              @if (getDoctorName(request)) {
                <div class="card-doctor">
                  <div class="doctor-avatar-sm">{{ getDoctorName(request).charAt(0) }}</div>
                  <span>{{ getDoctorName(request) }}</span>
                </div>
              }

              @if (hasAppointment(request)) {
                <div class="card-info-row">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <span>{{ request.appointment?.scheduled_at | date:'EEE, MMM d' }} at {{ request.appointment?.scheduled_at | date:'HH:mm' }}</span>
                  <span class="type-tag">
                    <ion-icon [name]="getAppointmentTypeIcon(request)"></ion-icon>
                    {{ getAppointmentTypeLabel(request) }}
                  </span>
                </div>
              }

              @if (isStatusRequested(request)) {
                <div class="card-info-row card-info-waiting">
                  <ion-icon name="hourglass-outline"></ion-icon>
                  <span>Awaiting doctor assignment</span>
                </div>
              }

              @if (isStatusRefused(request) && request.refused_reason) {
                <div class="card-info-row card-info-refused">
                  <ion-icon name="close-circle-outline"></ion-icon>
                  <span>{{ request.refused_reason }}</span>
                </div>
              }

              <div class="card-actions">
                @if (hasConsultation(request)) {
                  <button class="card-btn card-btn-outline" (click)="viewConsultationFromRequest(request); $event.stopPropagation()">
                    <ion-icon name="chatbubbles-outline"></ion-icon>
                    <span>Access consultation</span>
                  </button>
                } @else {
                  <button class="card-btn card-btn-secondary">
                    <span>View details</span>
                    <ion-icon name="chevron-forward-outline"></ion-icon>
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </section>

    @if (consultations().length > 0) {
      <section class="section consultations-section">
        <div class="section-header">
          <div class="section-title-group">
            <h2 class="section-title">My Consultations</h2>
            <span class="section-badge">{{ totalConsultations() }} total</span>
          </div>
        </div>

        <div class="cards-grid">
          @for (consultation of consultations(); track consultation.id) {
            <div class="consultation-card" (click)="viewConsultationDetails(consultation)">
              <div class="card-top-row">
                @if (consultation.created_at) {
                  <span class="card-date">{{ consultation.created_at | date:'MMM d, yyyy' }}</span>
                }
              </div>

              <h3 class="card-title">{{ getConsultationReasonName(consultation) }}</h3>

              @if (getConsultationDoctorName(consultation)) {
                <div class="card-doctor">
                  <div class="doctor-avatar-sm">{{ getConsultationDoctorName(consultation).charAt(0) }}</div>
                  <span>Managed by {{ getConsultationDoctorName(consultation) }}</span>
                </div>
              }

              @if (consultation.next_appointment) {
                <div class="card-info-row card-info-stacked">
                  <div class="card-info-label">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>Next appointment</span>
                  </div>
                  <div class="card-info-value">
                    <span>{{ consultation.next_appointment.scheduled_at | date:'EEE, MMM d' }} at {{ consultation.next_appointment.scheduled_at | date:'HH:mm' }}</span>
                    <span class="type-tag">
                      <ion-icon [name]="consultation.next_appointment.type === 'online' ? 'videocam-outline' : 'location-outline'"></ion-icon>
                      {{ consultation.next_appointment.type === 'online' ? 'Video' : 'In-person' }}
                    </span>
                  </div>
                </div>
              }

              <div class="card-actions">
                <button class="card-btn card-btn-outline">
                  <ion-icon name="chatbubbles-outline"></ion-icon>
                  <span>Access consultation</span>
                </button>
              </div>
            </div>
          }
        </div>
      </section>
    }

    @if (appointments().length > 0) {
      <section class="section appointments-section">
        <div class="section-header">
          <div class="section-title-group">
            <h2 class="section-title">My Appointments</h2>
            <span class="section-badge">{{ totalAppointments() }} total</span>
          </div>
        </div>

        <div class="cards-grid">
          @for (appointment of appointments(); track appointment.id) {
            <div class="appointment-card" (click)="viewAppointmentDetails(appointment)">
              <div class="card-top-row">
                <span class="status-badge status-{{ getAppointmentStatusConfig(appointment.status).color }}">
                  {{ getAppointmentStatusConfig(appointment.status).label }}
                </span>
                <span class="type-tag">
                  <ion-icon [name]="getAppointmentIcon(appointment)"></ion-icon>
                  {{ getAppointmentTypeText(appointment) }}
                </span>
              </div>

              <div class="card-info-row appointment-datetime">
                <ion-icon name="calendar-outline"></ion-icon>
                <span class="appointment-date-text">{{ appointment.scheduled_at | date:'EEEE, MMM d, yyyy' }} at {{ appointment.scheduled_at | date:'HH:mm' }}</span>
              </div>

              @if (getAppointmentDoctorName(appointment)) {
                <div class="card-doctor">
                  <div class="doctor-avatar-sm">{{ getAppointmentDoctorName(appointment).charAt(0) }}</div>
                  <span>{{ getAppointmentDoctorName(appointment) }}</span>
                </div>
              }

              <div class="card-actions">
                @if (appointment.type === 'online' && appointment.consultation_id) {
                  <button class="card-btn card-btn-primary" (click)="joinAppointment(appointment); $event.stopPropagation()">
                    <ion-icon name="videocam"></ion-icon>
                    <span>Join</span>
                  </button>
                }
                <button class="card-btn card-btn-secondary">
                  <span>View details</span>
                  <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
              </div>
            </div>
          }
        </div>
      </section>
    }
  </div>
</ion-content>

@if (footerHtml()) {
  <ion-footer class="ion-no-border home-footer">
    <ion-toolbar>
      <div class="footer-html" [innerHTML]="footerHtml()"></div>
    </ion-toolbar>
  </ion-footer>
}
