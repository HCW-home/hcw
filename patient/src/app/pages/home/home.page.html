<ion-header class="ion-no-border">
  <ion-toolbar>
    <div class="header-content">
      <div class="logo">
        <img src="assets/images/logo.svg" alt="HCW Logo" class="logo-img">
        <div class="logo-text-group">
          <span class="logo-text">HCW</span>
          <span class="logo-subtitle">Patient</span>
        </div>
      </div>
      <ion-buttons slot="end">
        <ion-button class="notification-btn" (click)="goToNotifications()">
          <ion-icon name="notifications-outline"></ion-icon>
          @if (unreadNotificationCount() > 0) {
            <span class="notification-badge">{{ unreadNotificationCount() > 9 ? '9+' : unreadNotificationCount() }}</span>
          }
        </ion-button>
        <ion-button class="user-avatar-btn" (click)="goToProfile()">
          <div class="user-avatar">
            @if (getUserPicture()) {
              <img [src]="getUserPicture()" alt="" class="avatar-image">
            } @else {
              {{ getUserInitials() }}
            }
          </div>
        </ion-button>
      </ion-buttons>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="home-content">
  <ion-refresher slot="fixed" (ionRefresh)="refreshData($any($event))">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="main-content">
    <div class="greeting">
      <p class="greeting-text">Welcome back,</p>
      <h1 class="greeting-name">{{ currentUser()?.first_name || 'User' }}</h1>
    </div>

    @if (nextAppointment()) {
      <div class="next-appointment-banner">
        <div class="next-appointment-icon">
          <ion-icon [name]="nextAppointment()!.type === 'online' ? 'videocam' : 'location-outline'"></ion-icon>
        </div>
        <div class="next-appointment-info">
          <span class="next-appointment-label">
            Next Appointment â€”
            <ion-icon [name]="nextAppointment()!.type === 'online' ? 'videocam-outline' : 'location-outline'"></ion-icon>
            {{ nextAppointment()!.type === 'online' ? 'Online' : 'In person' }}
          </span>
          <span class="next-appointment-date">
            {{ nextAppointment()!.scheduled_at | date:'EEEE, MMM d' }} at {{ nextAppointment()!.scheduled_at | date:'HH:mm' }}
          </span>
          @if (getNextAppointmentDoctorName()) {
            <span class="next-appointment-doctor">{{ getNextAppointmentDoctorName() }}</span>
          }
        </div>
        @if (nextAppointment()!.type === 'online') {
          <button class="join-button" (click)="joinNextAppointment()">
            <ion-icon name="videocam"></ion-icon>
            <span>Join</span>
          </button>
        } @else {
          <div class="in-person-badge">
            <ion-icon name="location-outline"></ion-icon>
            <span>In person</span>
          </div>
        }
      </div>
    }

    <section class="section requests-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">My Requests</h2>
          @if (totalRequests() > 0) {
            <span class="section-badge">{{ totalRequests() }} total</span>
          }
        </div>
      </div>

      @if (isLoading()) {
        <div class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      } @else if (requests().length === 0) {
        <div class="empty-state">
          <ion-icon name="document-text-outline" class="empty-icon"></ion-icon>
          <p class="empty-text">No requests yet</p>
          <p class="empty-hint">Tap the button above to request a consultation</p>
        </div>
      } @else {
        <div class="cards-grid">
          @for (request of requests(); track request.id) {
            <div class="request-card" (click)="viewRequestDetails(request)">
              <div class="request-header">
                <div class="request-title-row">
                  <h3 class="request-reason">{{ getReasonName(request) }}</h3>
                  <span class="status-badge status-{{ getStatusConfig(request.status).color }}">
                    {{ getStatusConfig(request.status).label }}
                  </span>
                </div>
                @if (getSpecialityName(request)) {
                  <span class="request-specialty">{{ getSpecialityName(request) }}</span>
                }
              </div>

              @if (hasAppointment(request)) {
                <div class="sub-section appointment-sub">
                  <div class="sub-section-header">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>Upcoming appointment</span>
                  </div>
                  <div class="appointment-content">
                    <div class="doctor-avatar">
                      {{ getDoctorName(request) ? getDoctorName(request).charAt(0) : '?' }}
                    </div>
                    <div class="appointment-details">
                      @if (getDoctorName(request)) {
                        <p class="doctor-name">{{ getDoctorName(request) }}</p>
                      }
                      <div class="appointment-meta">
                        <span class="meta-item">
                          <ion-icon name="calendar-outline"></ion-icon>
                          {{ request.appointment?.scheduled_at | date:'EEE, MMM d' }}
                        </span>
                        <span class="meta-item">
                          <ion-icon name="time-outline"></ion-icon>
                          {{ request.appointment?.scheduled_at | date:'HH:mm' }}
                        </span>
                        <span class="meta-item type-tag">
                          <ion-icon [name]="getAppointmentTypeIcon(request)"></ion-icon>
                          {{ getAppointmentTypeLabel(request) }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              }

              @if (hasConsultation(request)) {
                <div class="sub-section consultation-sub">
                  <div class="sub-section-header">
                    <ion-icon name="chatbubbles-outline"></ion-icon>
                    <span>Active consultation</span>
                  </div>
                  <div class="consultation-content">
                    <p class="consultation-hint">Tap to view messages</p>
                  </div>
                </div>
              }

              @if (isStatusRequested(request)) {
                <div class="sub-section pending-sub">
                  <div class="sub-section-header">
                    <ion-icon name="hourglass-outline"></ion-icon>
                    <span>Awaiting doctor assignment</span>
                  </div>
                </div>
              }

              @if (isStatusAccepted(request) && !hasAppointment(request)) {
                <div class="sub-section accepted-sub">
                  <div class="sub-section-header">
                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                    <span>Request accepted</span>
                  </div>
                  <p class="sub-hint">Appointment will be scheduled soon</p>
                </div>
              }

              @if (isStatusRefused(request)) {
                <div class="sub-section refused-sub">
                  <div class="sub-section-header">
                    <ion-icon name="close-circle-outline"></ion-icon>
                    <span>Request refused</span>
                  </div>
                  @if (request.refused_reason) {
                    <p class="sub-hint refused-reason">{{ request.refused_reason }}</p>
                  }
                </div>
              }

              <button class="card-action-btn">
                <span>View details</span>
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </button>
            </div>
          }
        </div>
      }
    </section>

    @if (consultations().length > 0) {
      <section class="section consultations-section">
        <div class="section-header">
          <div class="section-title-group">
            <h2 class="section-title">My Consultations</h2>
            <span class="section-badge">{{ totalConsultations() }} total</span>
          </div>
        </div>

        <div class="cards-grid">
          @for (consultation of consultations(); track consultation.id) {
            <div class="consultation-card" (click)="viewConsultationDetails(consultation)">
              <div class="consultation-header">
                <div class="consultation-title-row">
                  <h3 class="consultation-reason">{{ getConsultationReasonName(consultation) }}</h3>
                  <span class="status-badge status-{{ getConsultationStatusConfig(consultation.status).color }}">
                    {{ getConsultationStatusConfig(consultation.status).label }}
                  </span>
                </div>
                @if (getConsultationDoctorName(consultation)) {
                  <span class="consultation-doctor">{{ getConsultationDoctorName(consultation) }}</span>
                }
              </div>

              <div class="consultation-meta">
                @if (consultation.next_appointment) {
                  <span class="meta-item">
                    <ion-icon name="videocam-outline"></ion-icon>
                    {{ consultation.next_appointment.scheduled_at }}
                  </span>
                }
              </div>

              <button class="card-action-btn">
                <span>View consultation</span>
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </button>
            </div>
          }
        </div>
      </section>
    }

    @if (appointments().length > 0) {
      <section class="section appointments-section">
        <div class="section-header">
          <div class="section-title-group">
            <h2 class="section-title">My Appointments</h2>
            <span class="section-badge">{{ totalAppointments() }} total</span>
          </div>
        </div>

        <div class="cards-grid">
          @for (appointment of appointments(); track appointment.id) {
            <div class="appointment-card" (click)="viewAppointmentDetails(appointment)">
              <div class="appointment-header">
                <div class="appointment-title-row">
                  <div class="appointment-type-badge">
                    <ion-icon [name]="getAppointmentIcon(appointment)"></ion-icon>
                    <span>{{ getAppointmentTypeText(appointment) }}</span>
                  </div>
                  <span class="status-badge status-{{ getAppointmentStatusConfig(appointment.status).color }}">
                    {{ getAppointmentStatusConfig(appointment.status).label }}
                  </span>
                </div>
                @if (getAppointmentDoctorName(appointment)) {
                  <span class="appointment-doctor">{{ getAppointmentDoctorName(appointment) }}</span>
                }
              </div>

              <div class="appointment-meta">
                <span class="meta-item">
                  <ion-icon name="calendar-outline"></ion-icon>
                  {{ appointment.scheduled_at | date:'EEE, MMM d, yyyy' }}
                </span>
                <span class="meta-item">
                  <ion-icon name="time-outline"></ion-icon>
                  {{ appointment.scheduled_at | date:'HH:mm' }}
                </span>
              </div>

              <button class="card-action-btn">
                <span>View details</span>
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </button>
            </div>
          }
        </div>
      </section>
    }
  </div>
</ion-content>

<ion-footer class="ion-no-border home-footer">
  <ion-toolbar>
    <div class="footer-content">
      <div class="footer-html-placeholder"></div>
      <button class="cta-button" [class.cta-filled]="totalRequests() === 0 && totalConsultations() === 0 && totalAppointments() === 0" (click)="goToNewRequest()">
        <ion-icon name="add-outline"></ion-icon>
        <span>Request a consultation</span>
      </button>
    </div>
  </ion-toolbar>
</ion-footer>
