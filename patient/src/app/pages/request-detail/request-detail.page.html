<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text="" icon="arrow-back-outline"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="request-detail-content">
  @if (isLoading()) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  } @else if (request()) {
    <div class="main-content">
      <div class="request-header-section">
        <span class="status-badge status-{{ getStatusConfig(request()?.status).color }}">
          {{ getStatusConfig(request()?.status).label }}
        </span>
        <h1 class="request-title">{{ getReasonName() }}</h1>
        @if (getSpecialityName()) {
          <p class="request-specialty">{{ getSpecialityName() }}</p>
        }
        <p class="request-type">
          <ion-icon [name]="request()?.type === 'online' ? 'videocam-outline' : 'location-outline'"></ion-icon>
          {{ getTypeLabel() }}
        </p>
      </div>

      <div class="info-card">
        <h3 class="info-title">{{ 'requestDetail.requestDetails' | translate }}</h3>
        <div class="info-row">
          <span class="info-label">{{ 'requestDetail.created' | translate }}</span>
          <span class="info-value">{{ request()?.created_at | date:'MMM d, yyyy - HH:mm' }}</span>
        </div>
        @if (request()?.expected_at) {
          <div class="info-row">
            <span class="info-label">{{ 'requestDetail.preferredTime' | translate }}</span>
            <span class="info-value">{{ request()?.expected_at | date:'MMM d, yyyy - HH:mm' }}</span>
          </div>
        }
        @if (request()?.comment) {
          <div class="info-row comment-row">
            <span class="info-label">{{ 'requestDetail.yourComment' | translate }}</span>
            <span class="info-value comment">{{ request()?.comment }}</span>
          </div>
        }
      </div>

      @if (hasAppointment()) {
        <div class="info-card appointment-card">
          <div class="card-header">
            <ion-icon name="calendar-outline" class="card-icon"></ion-icon>
            <h3 class="info-title">{{ 'requestDetail.scheduledAppointment' | translate }}</h3>
          </div>
          <div class="appointment-details">
            @if (getDoctorName()) {
              <div class="doctor-row">
                <div class="doctor-avatar">
                  {{ getDoctorName().charAt(0) }}
                </div>
                <span class="doctor-name">{{ getDoctorName() }}</span>
              </div>
            }
            <div class="appointment-meta">
              <div class="meta-item">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>{{ request()?.appointment?.scheduled_at | localDate:'EEEE, MMM d, yyyy' }}</span>
              </div>
              <div class="meta-item">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ request()?.appointment?.scheduled_at | localDate:'HH:mm' }}</span>
              </div>
              <div class="meta-item type-item">
                <ion-icon [name]="getAppointmentTypeIcon()"></ion-icon>
                <span>{{ getAppointmentTypeLabel() }}</span>
              </div>
            </div>
          </div>
            <button class="action-button primary-btn" (click)="joinAppointment()">
              <ion-icon name="videocam-outline"></ion-icon>
              {{ 'requestDetail.joinVideoCall' | translate }}
            </button>
        </div>
      }

      @if (hasConsultation()) {
        <div class="chat-section">
          <app-message-list
            [messages]="messages()"
            [isConnected]="isConnected()"
            [isLoadingMore]="isLoadingMore()"
            [hasMore]="hasMore()"
            (sendMessage)="onSendMessage($event)"
            (editMessage)="onEditMessage($event)"
            (deleteMessage)="onDeleteMessage($event)"
            (loadMore)="onLoadMore()">
          </app-message-list>
        </div>
      }

      @if (isStatusRequested()) {
        <div class="info-card pending-card">
          <div class="card-header">
            <ion-icon name="hourglass-outline" class="card-icon"></ion-icon>
            <h3 class="info-title">{{ 'requestDetail.awaitingAssignment' | translate }}</h3>
          </div>
          <p class="pending-text">{{ 'requestDetail.awaitingText' | translate }}</p>
          <button class="action-button danger-btn" (click)="cancelRequest()">
            {{ 'requestDetail.cancelRequest' | translate }}
          </button>
        </div>
      }

      @if (isStatusAccepted() && !hasAppointment()) {
        <div class="info-card accepted-card">
          <div class="card-header">
            <ion-icon name="checkmark-circle-outline" class="card-icon"></ion-icon>
            <h3 class="info-title">{{ 'requestDetail.requestAccepted' | translate }}</h3>
          </div>
          <p class="accepted-text">{{ 'requestDetail.acceptedText' | translate }}</p>
        </div>
      }

      @if (isStatusRefused() && request()?.refused_reason) {
        <div class="info-card refused-card">
          <div class="card-header">
            <ion-icon name="close-circle-outline" class="card-icon"></ion-icon>
            <h3 class="info-title">{{ 'requestDetail.requestRefused' | translate }}</h3>
          </div>
          <p class="refused-reason">{{ request()?.refused_reason }}</p>
        </div>
      }
    </div>
  } @else {
    <div class="empty-state">
      <ion-icon name="document-text-outline" class="empty-icon"></ion-icon>
      <p class="empty-text">{{ 'requestDetail.notFound' | translate }}</p>
    </div>
  }
</ion-content>
