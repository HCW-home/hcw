@if (!selectedConsultation) {
  <ion-header>
    <ion-toolbar>
      <ion-title>Messages</ion-title>
    </ion-toolbar>
    <ion-toolbar>
      <ion-searchbar
        placeholder="Search conversations"
        (ionInput)="searchConversations($event)"
        [debounce]="300">
      </ion-searchbar>
    </ion-toolbar>
  </ion-header>

  <ion-content>
    <ion-refresher slot="fixed" (ionRefresh)="refreshConversations($event)">
      <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    @if (isLoading) {
      <div class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <ion-text color="medium">Loading conversations...</ion-text>
      </div>
    } @else if (filteredConversations.length === 0) {
      <div class="empty-state">
        <ion-icon name="chatbubbles-outline" color="medium"></ion-icon>
        <ion-text color="medium">
          <h3>No conversations yet</h3>
          <p>Your consultation messages will appear here</p>
        </ion-text>
      </div>
    } @else {
      <ion-list lines="full">
        @for (thread of filteredConversations; track thread.consultation.id) {
          <ion-item button (click)="selectConversation(thread)" detail>
            <ion-avatar slot="start" class="conversation-avatar">
              <div class="avatar-placeholder">{{ getParticipantInitial(thread.consultation) }}</div>
            </ion-avatar>
            <ion-label>
              <h2>{{ getParticipantName(thread.consultation) }}</h2>
              @if (thread.lastMessage) {
                <p class="last-message">{{ thread.lastMessage.content }}</p>
              } @else {
                <p class="last-message">No messages yet</p>
              }
            </ion-label>
            <div slot="end" class="conversation-meta">
              @if (thread.lastMessage) {
                <ion-note>{{ formatTime(thread.lastMessage.created_at) }}</ion-note>
              }
              @if (thread.unreadCount > 0) {
                <ion-badge color="primary">{{ thread.unreadCount }}</ion-badge>
              }
            </div>
          </ion-item>
        }
      </ion-list>
    }
  </ion-content>
} @else {
  <ion-header>
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button (click)="backToList()">
          <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-avatar slot="start" class="header-avatar">
        <div class="avatar-placeholder small">{{ getParticipantInitial(selectedConsultation) }}</div>
      </ion-avatar>
      <ion-title>{{ getParticipantName(selectedConsultation) }}</ion-title>
      @if (isReconnecting) {
        <ion-spinner slot="end" name="dots"></ion-spinner>
      } @else if (isConnected) {
        <ion-icon slot="end" name="wifi" color="success" class="connection-icon"></ion-icon>
      }
    </ion-toolbar>
  </ion-header>

  <ion-content #messageContent class="chat-content">
    @if (isLoadingMessages) {
      <div class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
      </div>
    } @else if (messages.length === 0) {
      <div class="empty-chat">
        <ion-icon name="chatbubble-outline" color="medium"></ion-icon>
        <ion-text color="medium">
          <p>Start the conversation</p>
        </ion-text>
      </div>
    } @else {
      <ion-infinite-scroll position="top" (ionInfinite)="loadMoreMessages($any($event))" [disabled]="!hasMoreMessages">
        <ion-infinite-scroll-content loadingSpinner="crescent" loadingText="Loading older messages...">
        </ion-infinite-scroll-content>
      </ion-infinite-scroll>

      <div class="messages-container">
        @for (message of messages; track message.id) {
          <div class="message-wrapper" [class.own]="isOwnMessage(message)">
            @if (editingMessageId === message.id) {
              <div class="edit-message-container">
                <ion-input
                  [(ngModel)]="editContent"
                  placeholder="Edit message..."
                  (keyup.enter)="saveEdit()"
                  class="edit-input">
                </ion-input>
                <div class="edit-actions">
                  <ion-button fill="clear" size="small" (click)="cancelEdit()">
                    <ion-icon name="close-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                  <ion-button fill="clear" size="small" (click)="saveEdit()" [disabled]="!editContent.trim() || isEditing">
                    @if (isEditing) {
                      <ion-spinner name="dots"></ion-spinner>
                    } @else {
                      <ion-icon name="checkmark-circle-outline" slot="icon-only" color="success"></ion-icon>
                    }
                  </ion-button>
                </div>
              </div>
            } @else {
              <div class="message-bubble" [class.own]="isOwnMessage(message)">
                @if (!isOwnMessage(message)) {
                  <div class="sender-name">{{ message.created_by.first_name }}</div>
                }
                <div class="message-content">{{ message.content }}</div>
                <div class="message-meta">
                  <span class="message-time">{{ formatTime(message.created_at) }}</span>
                  @if (message.is_edited) {
                    <span class="message-edited">(edited)</span>
                  }
                  @if (canEditMessage(message)) {
                    <ion-button fill="clear" size="small" class="edit-button" (click)="startEdit(message)">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </ion-content>

  <ion-footer class="chat-footer">
    <ion-toolbar>
      <div class="message-input-container">
        <ion-input
          [(ngModel)]="newMessage"
          placeholder="Type a message..."
          (keyup.enter)="sendMessage()"
          class="message-input">
        </ion-input>
        <ion-button
          fill="clear"
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || isSending"
          class="send-button">
          @if (isSending) {
            <ion-spinner name="dots"></ion-spinner>
          } @else {
            <ion-icon name="send" slot="icon-only"></ion-icon>
          }
        </ion-button>
      </div>
    </ion-toolbar>
  </ion-footer>
}
