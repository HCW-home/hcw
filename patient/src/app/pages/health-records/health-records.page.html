<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Health Records</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="health-records-content">
  <ion-segment [(ngModel)]="selectedSegment" (ionChange)="segmentChanged($event)">
    <ion-segment-button value="medical-history">
      <ion-label>Medical History</ion-label>
    </ion-segment-button>
    <ion-segment-button value="test-results">
      <ion-label>Test Results</ion-label>
    </ion-segment-button>
    <ion-segment-button value="prescriptions">
      <ion-label>Prescriptions</ion-label>
    </ion-segment-button>
  </ion-segment>

  <div class="segment-content">
    @if (isLoading) {
      <div class="loading-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <ion-text color="medium">Loading health records...</ion-text>
      </div>
    } @else {
      @switch (selectedSegment) {
        @case ('medical-history') {
          <div class="medical-history">
            @if (medicalRecords.length > 0) {
              <ion-list lines="none">
                @for (record of medicalRecords; track record.id) {
                  <ion-card (click)="viewRecord(record)" class="record-card">
                    <ion-card-content>
                      <div class="record-header">
                        <div class="record-icon-wrapper" [style.background-color]="'var(--ion-color-' + record.color + '-tint)'">
                          <ion-icon [name]="record.icon" [color]="record.color"></ion-icon>
                        </div>
                        <div class="record-info">
                          <ion-text class="record-title">{{ record.title }}</ion-text>
                          <ion-text class="record-doctor" color="medium">{{ record.doctor }}</ion-text>
                          <ion-text class="record-date" color="medium">{{ formatDate(record.date) }}</ion-text>
                        </div>
                        @if (record.status) {
                          <ion-badge [color]="getStatusColor(record.status)">
                            {{ record.status }}
                          </ion-badge>
                        }
                      </div>
                      <div class="record-actions">
                        <ion-button size="small" fill="clear" (click)="downloadRecord(record, $event)">
                          <ion-icon name="download-outline" slot="icon-only"></ion-icon>
                        </ion-button>
                        <ion-button size="small" fill="clear" (click)="shareRecord(record, $event)">
                          <ion-icon name="share-outline" slot="icon-only"></ion-icon>
                        </ion-button>
                      </div>
                    </ion-card-content>
                  </ion-card>
                }
              </ion-list>
            } @else {
              <div class="empty-state">
                <ion-icon name="document-text-outline" color="medium"></ion-icon>
                <ion-text color="medium">No medical records found</ion-text>
              </div>
            }
          </div>
        }

        @case ('test-results') {
          <div class="test-results">
            @for (category of testResults; track category.category) {
              <ion-card>
                <ion-card-header>
                  <ion-card-title>{{ category.category }}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                  <ion-list lines="none">
                    @for (test of category.tests; track test.name) {
                      <ion-item class="test-item">
                        <ion-label>
                          <ion-text class="test-name">{{ test.name }}</ion-text>
                          <ion-text class="test-range" color="medium">Normal: {{ test.range }} {{ test.unit }}</ion-text>
                        </ion-label>
                        <div slot="end" class="test-value-wrapper">
                          <ion-text class="test-value" [color]="getStatusColor(test.status)">
                            {{ test.value }} {{ test.unit }}
                          </ion-text>
                          @if (test.status === 'high' || test.status === 'low') {
                            <ion-icon
                              [name]="test.status === 'high' ? 'arrow-up' : 'arrow-down'"
                              [color]="getStatusColor(test.status)">
                            </ion-icon>
                          }
                        </div>
                      </ion-item>
                    }
                  </ion-list>
                </ion-card-content>
              </ion-card>
            }
          </div>
        }

        @case ('prescriptions') {
          <div class="prescriptions">
            @if (prescriptions.length > 0) {
              <div class="prescription-sections">
                <ion-text class="section-title">Active Prescriptions</ion-text>
                @for (prescription of prescriptions; track prescription.id) {
                  @if (prescription.active) {
                    <ion-card class="prescription-card">
                      <ion-card-content>
                        <div class="prescription-header">
                          <div class="prescription-info">
                            <ion-text class="medication-name">{{ prescription.medication }}</ion-text>
                            <ion-text class="medication-dosage" color="primary">{{ prescription.dosage }}</ion-text>
                          </div>
                          <ion-badge color="success">Active</ion-badge>
                        </div>
                        <div class="prescription-details">
                          <ion-item lines="none">
                            <ion-icon name="time-outline" slot="start" color="medium"></ion-icon>
                            <ion-label>
                              <ion-text color="medium">{{ prescription.frequency }}</ion-text>
                            </ion-label>
                          </ion-item>
                          <ion-item lines="none">
                            <ion-icon name="calendar-outline" slot="start" color="medium"></ion-icon>
                            <ion-label>
                              <ion-text color="medium">{{ prescription.duration }}</ion-text>
                            </ion-label>
                          </ion-item>
                          <ion-item lines="none">
                            <ion-icon name="person-outline" slot="start" color="medium"></ion-icon>
                            <ion-label>
                              <ion-text color="medium">{{ prescription.doctor }}</ion-text>
                            </ion-label>
                          </ion-item>
                        </div>
                        <ion-button expand="block" size="small" (click)="refillPrescription(prescription)">
                          Request Refill
                        </ion-button>
                      </ion-card-content>
                    </ion-card>
                  }
                }

                <ion-text class="section-title">Past Prescriptions</ion-text>
                @for (prescription of prescriptions; track prescription.id) {
                  @if (!prescription.active) {
                    <ion-card class="prescription-card inactive">
                      <ion-card-content>
                        <div class="prescription-header">
                          <div class="prescription-info">
                            <ion-text class="medication-name">{{ prescription.medication }}</ion-text>
                            <ion-text class="medication-dosage" color="medium">{{ prescription.dosage }}</ion-text>
                          </div>
                          <ion-badge color="medium">Completed</ion-badge>
                        </div>
                        <div class="prescription-meta">
                          <ion-text color="medium">{{ prescription.doctor }} â€¢ {{ formatDate(prescription.date) }}</ion-text>
                        </div>
                      </ion-card-content>
                    </ion-card>
                  }
                }
              </div>
            } @else {
              <div class="empty-state">
                <ion-icon name="medical-outline" color="medium"></ion-icon>
                <ion-text color="medium">No prescriptions found</ion-text>
              </div>
            }
          </div>
        }
      }
    }
  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="uploadDocument()">
      <ion-icon name="cloud-upload-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>