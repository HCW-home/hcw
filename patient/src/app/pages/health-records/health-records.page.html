<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Health Records</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="health-records-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-segment [(ngModel)]="selectedSegment" (ionChange)="segmentChanged($event)">
    <ion-segment-button value="metrics">
      <ion-label>Health Metrics</ion-label>
    </ion-segment-button>
    <ion-segment-button value="prescriptions">
      <ion-label>Prescriptions</ion-label>
    </ion-segment-button>
  </ion-segment>

  <div class="segment-content">
    @if (isLoading) {
      <div class="loading-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <ion-text color="medium">Loading health records...</ion-text>
      </div>
    } @else {
      @switch (selectedSegment) {
        @case ('metrics') {
          <div class="health-metrics">
            @if (groupedMetrics.length > 0) {
              @for (group of groupedMetrics; track group.category) {
                <ion-card>
                  <ion-card-header>
                    <ion-card-title>{{ group.category }}</ion-card-title>
                  </ion-card-header>
                  <ion-card-content>
                    <ion-list lines="none">
                      @for (metric of group.metrics; track metric.name + metric.date) {
                        <ion-item class="metric-item">
                          <ion-label>
                            <ion-text class="metric-name">{{ metric.name }}</ion-text>
                            <ion-text class="metric-date" color="medium">{{ formatDate(metric.date) }}</ion-text>
                          </ion-label>
                          <div slot="end" class="metric-value-wrapper">
                            <ion-text class="metric-value" [color]="getStatusColor(metric.status)">
                              {{ metric.value }} {{ metric.unit }}
                            </ion-text>
                          </div>
                        </ion-item>
                      }
                    </ion-list>
                  </ion-card-content>
                </ion-card>
              }
            } @else {
              <div class="empty-state">
                <ion-icon name="fitness-outline" color="medium"></ion-icon>
                <ion-text color="medium">No health metrics recorded</ion-text>
                <ion-text color="medium" class="empty-subtitle">Your health metrics will appear here</ion-text>
              </div>
            }
          </div>
        }

        @case ('prescriptions') {
          <div class="prescriptions">
            @if (isLoadingPrescriptions) {
              <div class="loading-container">
                <ion-spinner name="crescent" color="primary"></ion-spinner>
              </div>
            } @else if (prescriptions.length > 0) {
              <div class="prescription-sections">
                @for (prescription of prescriptions; track prescription.id) {
                  <ion-card class="prescription-card" [class.inactive]="prescription.status === 'dispensed' || prescription.status === 'cancelled'">
                    <ion-card-content>
                      <div class="prescription-header">
                        <div class="prescription-info">
                          <ion-text class="medication-name">{{ prescription.medication_name }}</ion-text>
                          <ion-text class="medication-dosage" color="primary">{{ prescription.dosage }}</ion-text>
                        </div>
                        <ion-badge [color]="getPrescriptionStatusColor(prescription.status)">
                          {{ prescription.status }}
                        </ion-badge>
                      </div>
                      <div class="prescription-details">
                        <ion-item lines="none">
                          <ion-icon name="time-outline" slot="start" color="medium"></ion-icon>
                          <ion-label>
                            <ion-text color="medium">{{ prescription.frequency }}</ion-text>
                          </ion-label>
                        </ion-item>
                        @if (prescription.duration) {
                          <ion-item lines="none">
                            <ion-icon name="calendar-outline" slot="start" color="medium"></ion-icon>
                            <ion-label>
                              <ion-text color="medium">{{ prescription.duration }}</ion-text>
                            </ion-label>
                          </ion-item>
                        }
                        @if (prescription.instructions) {
                          <ion-item lines="none">
                            <ion-icon name="information-circle-outline" slot="start" color="medium"></ion-icon>
                            <ion-label>
                              <ion-text color="medium">{{ prescription.instructions }}</ion-text>
                            </ion-label>
                          </ion-item>
                        }
                      </div>
                      @if (prescription.status === 'prescribed') {
                        <ion-button expand="block" size="small" (click)="refillPrescription(prescription)">
                          Request Refill
                        </ion-button>
                      }
                    </ion-card-content>
                  </ion-card>
                }
              </div>
            } @else {
              <div class="empty-state">
                <ion-icon name="medical-outline" color="medium"></ion-icon>
                <ion-text color="medium">No prescriptions found</ion-text>
              </div>
            }
          </div>
        }
      }
    }
  </div>

</ion-content>
