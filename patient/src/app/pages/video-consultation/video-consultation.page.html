<ion-content class="video-consultation-content" [scrollY]="false" (click)="onVideoAreaTap()">
  <div class="video-container">
    <div class="remote-video-wrapper" #participantsContainer>
      @if (connectionStatus === 'connected' && getParticipantsArray().length > 0) {
        @for (participant of getParticipantsArray(); track participant.identity) {
          @if (!participant.isCameraEnabled) {
            <div class="video-placeholder">
              <ion-avatar class="participant-avatar">
                <div class="avatar-initials">{{ participant.name.charAt(0) }}</div>
              </ion-avatar>
              <ion-text class="participant-name">{{ participant.name }}</ion-text>
            </div>
          }
          @if (participant.isMicrophoneEnabled === false) {
            <div class="mute-indicator remote">
              <ion-icon name="mic-off"></ion-icon>
            </div>
          }
        }
      } @else {
        <div class="video-placeholder">
          <ion-avatar class="participant-avatar">
            <div class="avatar-initials">?</div>
          </ion-avatar>
          <ion-text class="participant-name">Waiting for practitioner...</ion-text>
          @if (connectionStatus !== 'connected') {
            <ion-text class="status-message" color="light">{{ getCallStateMessage() }}</ion-text>
            @if (connectionStatus === 'connecting' || connectionStatus === 'reconnecting' || isLoading) {
              <ion-spinner name="crescent" color="light"></ion-spinner>
            }
          }
        </div>
      }
    </div>

    <div class="local-video-wrapper" [class.video-off]="!isCameraEnabled">
      @if (isCameraEnabled) {
        <video #localVideo autoplay playsinline muted class="local-video"></video>
      } @else {
        <div class="local-video-placeholder">
          <ion-icon name="videocam-off"></ion-icon>
        </div>
      }
      @if (!isMicrophoneEnabled) {
        <div class="mute-indicator local">
          <ion-icon name="mic-off"></ion-icon>
        </div>
      }
    </div>

    @if (showControls || connectionStatus !== 'connected') {
      <div class="top-bar">
        <div class="call-info">
          @if (connectionStatus === 'connected') {
            <ion-chip color="success" class="duration-chip">
              <ion-icon name="ellipse" class="recording-dot"></ion-icon>
              <ion-text>{{ formattedDuration }}</ion-text>
            </ion-chip>
          }
          @if (isScreenShareEnabled) {
            <ion-chip color="warning">
              <ion-icon name="desktop-outline"></ion-icon>
              <ion-text>Sharing</ion-text>
            </ion-chip>
          }
        </div>
        <div class="top-actions">
          <ion-button fill="clear" color="light" (click)="switchCamera(); $event.stopPropagation()">
            <ion-icon name="camera-reverse-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>

      <div class="controls-bar">
        <div class="controls-wrapper">
          <ion-button
            [color]="!isMicrophoneEnabled ? 'danger' : 'light'"
            class="control-button"
            (click)="toggleMicrophone(); $event.stopPropagation()">
            <ion-icon [name]="!isMicrophoneEnabled ? 'mic-off' : 'mic'" slot="icon-only"></ion-icon>
          </ion-button>

          <ion-button
            [color]="!isCameraEnabled ? 'danger' : 'light'"
            class="control-button"
            (click)="toggleCamera(); $event.stopPropagation()">
            <ion-icon [name]="!isCameraEnabled ? 'videocam-off' : 'videocam'" slot="icon-only"></ion-icon>
          </ion-button>

          <ion-button
            color="danger"
            class="control-button end-call"
            (click)="endCall(); $event.stopPropagation()">
            <ion-icon name="call" slot="icon-only"></ion-icon>
          </ion-button>

          <ion-button
            [color]="isSpeakerOn ? 'light' : 'medium'"
            class="control-button"
            (click)="toggleSpeaker(); $event.stopPropagation()">
            <ion-icon [name]="isSpeakerOn ? 'volume-high' : 'volume-mute'" slot="icon-only"></ion-icon>
          </ion-button>

          <ion-button
            [color]="isScreenShareEnabled ? 'primary' : 'light'"
            class="control-button"
            (click)="toggleScreenShare(); $event.stopPropagation()">
            <ion-icon name="desktop-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <div class="secondary-controls">
          <ion-button
            fill="clear"
            color="light"
            class="secondary-button"
            (click)="openChat(); $event.stopPropagation()">
            <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
            Chat
          </ion-button>
        </div>
      </div>
    }

    @if (connectionStatus === 'disconnected' && !isLoading && callDuration > 0) {
      <div class="call-ended-overlay">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
        <ion-text>Consultation Ended</ion-text>
        <ion-text color="medium">Duration: {{ formattedDuration }}</ion-text>
      </div>
    }

    @if (connectionStatus === 'failed') {
      <div class="call-failed-overlay">
        <ion-icon name="alert-circle" color="danger"></ion-icon>
        <ion-text>Connection Failed</ion-text>
        @if (errorMessage) {
          <ion-text color="medium" class="error-message">{{ errorMessage }}</ion-text>
        }
        <ion-button fill="outline" color="light" (click)="joinRoom()">
          Try Again
        </ion-button>
        <ion-button fill="clear" color="light" (click)="navCtrl.back()">
          Go Back
        </ion-button>
      </div>
    }
  </div>
</ion-content>
