<app-header
  [pageTitle]="'consultationDetail.title' | translate"
  [showBackButton]="true"
  backHref="/home"
></app-header>

<ion-content class="consultation-detail-content">
  @if (isLoading()) {
  <div class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
  </div>
  } @else if (consultation()) {
  <div class="main-content">
    <div class="consultation-header-section">
      <div class="header-top">
        <span
          class="status-badge status-{{ getStatusConfig(consultation()?.status).color }}"
        >
          {{ getStatusConfig(consultation()?.status).label }}
        </span>
      </div>
      <h2 class="consultation-title">{{ getReasonName() }}</h2>
      <div class="header-dates">
        <div class="date-item">
          <ion-icon name="calendar-outline"></ion-icon>
          <span
            >{{ 'consultationDetail.created' | translate }} {{ consultation()?.created_at | date:'MMM d, yyyy - HH:mm'
            }}</span
          >
        </div>
        @if (consultation()?.started_at) {
        <div class="date-item">
          <ion-icon name="time-outline"></ion-icon>
          <span
            >{{ 'consultationDetail.activeSince' | translate }} {{ consultation()?.started_at | date:'MMM d, yyyy -
            HH:mm' }}</span
          >
        </div>
        } @if (consultation()?.closed_at) {
        <div class="date-item">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <span
            >{{ 'consultationDetail.closed' | translate }} {{ consultation()?.closed_at | date:'MMM d, yyyy - HH:mm'
            }}</span
          >
        </div>
        }
      </div>
    </div>

    @if (getDoctorName()) {
    <div class="info-card doctor-card">
      <div class="card-header">
        <ion-icon name="person-outline" class="card-icon"></ion-icon>
        <h3 class="info-title">{{ 'consultationDetail.handledBy' | translate }}</h3>
      </div>
      <div class="doctor-row">
        <div class="doctor-avatar">{{ getDoctorInitial() }}</div>
        <span class="doctor-name">{{ getDoctorName() }}</span>
      </div>
    </div>
    } @if (consultation()?.next_appointment; as appointment) {
    <div class="info-card appointments-card">
      <div class="card-header">
        <ion-icon name="calendar-outline" class="card-icon"></ion-icon>
        <h3 class="info-title">{{ 'consultationDetail.nextAppointment' | translate }}</h3>
      </div>
      <div class="appointment-item">
        <div class="appointment-meta">
          <div class="meta-item">
            <ion-icon name="calendar-outline"></ion-icon>
            <span
              >{{ appointment.scheduled_at | localDate:'EEEE, MMM d, yyyy' }}</span
            >
          </div>
          <div class="meta-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ appointment.scheduled_at | localDate:'HH:mm' }}</span>
          </div>
          <div class="meta-item type-item">
            <ion-icon [name]="getAppointmentTypeIcon(appointment)"></ion-icon>
            <span>{{ getAppointmentTypeLabel(appointment) }}</span>
          </div>
        </div>
        @if (appointment.type === 'online') {
        <button
          class="action-button primary-btn"
          (click)="joinAppointment(appointment)"
        >
          <ion-icon name="videocam-outline"></ion-icon>
          {{ 'consultationDetail.joinVideoCall' | translate }}
        </button>
        }
      </div>
    </div>
    } @if (isConsultationClosed()) {
    <div class="info-card closed-card">
      <div class="card-header">
        <ion-icon name="checkmark-circle-outline" class="card-icon"></ion-icon>
        <h3 class="info-title">{{ 'consultationDetail.consultationClosed' | translate }}</h3>
      </div>
      <p class="closed-text">
        {{ 'consultationDetail.closedText' | translate }}
      </p>
    </div>
    }

    <div class="chat-section" [class.read-only]="isConsultationClosed()">
      <div class="chat-header">
        <ion-icon name="chatbubbles-outline"></ion-icon>
        <span
          >{{ isConsultationClosed() ? ('consultationDetail.messageHistory' | translate) : ('consultationDetail.messages' | translate) }}</span
        >
      </div>
      <app-message-list
        [messages]="messages()"
        [isConnected]="isConsultationClosed() ? false : isConnected()"
        [isLoadingMore]="isLoadingMore()"
        [hasMore]="hasMore()"
        (sendMessage)="onSendMessage($event)"
        (editMessage)="onEditMessage($event)"
        (deleteMessage)="onDeleteMessage($event)"
        (loadMore)="onLoadMore()"
      >
      </app-message-list>
    </div>
  </div>
  } @else {
  <div class="empty-state">
    <ion-icon name="document-text-outline" class="empty-icon"></ion-icon>
    <p class="empty-text">{{ 'consultationDetail.notFound' | translate }}</p>
  </div>
  }
</ion-content>

<app-footer></app-footer>
