<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/doctors"></ion-back-button>
    </ion-buttons>
    <ion-title>Doctor Profile</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="doctor-detail-content">
  @if (isLoading) {
    <div class="loading-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
    </div>
  } @else if (doctor) {
    <div class="doctor-header">
      <ion-card class="profile-card">
        <ion-card-content>
          <div class="profile-section">
            <ion-avatar class="doctor-avatar">
              <img [src]="doctor.picture || 'assets/images/default-doctor.svg'" [alt]="doctor.first_name">
            </ion-avatar>
            <div class="doctor-info">
              <ion-text class="doctor-name">
                Dr. {{ doctor.first_name }} {{ doctor.last_name }}
              </ion-text>
              @if (doctor.specialities && doctor.specialities.length > 0) {
                <ion-text class="doctor-specialty" color="medium">
                  {{ doctor.specialities[0].name }}
                </ion-text>
              }
              <div class="doctor-meta">
                @if (doctor.experience_years) {
                  <ion-badge color="light">
                    <ion-icon name="briefcase-outline"></ion-icon>
                    {{ doctor.experience_years }} years
                  </ion-badge>
                }
                @if (doctor.rating) {
                  <ion-badge color="warning">
                    <ion-icon name="star"></ion-icon>
                    {{ doctor.rating }}
                  </ion-badge>
                }
                @if (doctor.is_online) {
                  <ion-badge color="success">
                    <ion-icon name="checkmark-circle"></ion-icon>
                    Online
                  </ion-badge>
                }
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <ion-button expand="block" color="primary" (click)="bookAppointment()">
              <ion-icon name="calendar-outline" slot="start"></ion-icon>
              Book Appointment
            </ion-button>
            <ion-button expand="block" fill="outline" color="primary" (click)="messageDoctor()">
              <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
              Message
            </ion-button>
          </div>

          @if (doctor.consultation_fee) {
            <div class="consultation-fee">
              <ion-text color="medium">Consultation Fee:</ion-text>
              <ion-text class="fee-amount">${{ doctor.consultation_fee }}</ion-text>
            </div>
          }
        </ion-card-content>
      </ion-card>
    </div>

    <div class="content-tabs">
      <ion-segment [(ngModel)]="selectedSegment" (ionChange)="segmentChanged($event)">
        <ion-segment-button value="about">
          <ion-label>About</ion-label>
        </ion-segment-button>
        <ion-segment-button value="availability">
          <ion-label>Availability</ion-label>
        </ion-segment-button>
        <ion-segment-button value="reviews">
          <ion-label>Reviews</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <div class="segment-content">
      @switch (selectedSegment) {
        @case ('about') {
          <div class="about-section">
            @if (doctor.about) {
              <ion-card>
                <ion-card-content>
                  <ion-text class="section-title">Biography</ion-text>
                  <ion-text class="section-content">{{ doctor.about }}</ion-text>
                </ion-card-content>
              </ion-card>
            }

            @if (doctor.education && doctor.education.length > 0) {
              <ion-card>
                <ion-card-content>
                  <ion-text class="section-title">Education</ion-text>
                  <ion-list lines="none">
                    @for (edu of doctor.education; track edu) {
                      <ion-item>
                        <ion-icon name="school-outline" slot="start" color="primary"></ion-icon>
                        <ion-label>{{ edu }}</ion-label>
                      </ion-item>
                    }
                  </ion-list>
                </ion-card-content>
              </ion-card>
            }

            @if (doctor.languages && doctor.languages.length > 0) {
              <ion-card>
                <ion-card-content>
                  <ion-text class="section-title">Languages</ion-text>
                  <div class="language-chips">
                    @for (lang of doctor.languages; track lang.id) {
                      <ion-chip color="primary" outline="true">
                        <ion-label>{{ lang.name }}</ion-label>
                      </ion-chip>
                    }
                  </div>
                </ion-card-content>
              </ion-card>
            }
          </div>
        }

        @case ('availability') {
          <div class="availability-section">
            <ion-card>
              <ion-card-content>
                <ion-text class="section-title">Available Time Slots</ion-text>
                <div class="calendar-view">
                  @for (daySlot of availableSlots; track daySlot.date) {
                    <div class="day-column">
                      <div class="day-header" [class.today]="daySlot.isToday">
                        <ion-text class="day-name">{{ daySlot.day }}</ion-text>
                        <ion-text class="day-date">{{ daySlot.dateStr }}</ion-text>
                        <ion-text class="day-month">{{ daySlot.month }}</ion-text>
                      </div>
                      <div class="time-slots">
                        @for (slot of daySlot.slots.slice(0, 4); track slot) {
                          <div class="time-slot">{{ slot }}</div>
                        }
                        @if (daySlot.slots.length > 4) {
                          <ion-text class="more-slots" color="primary">
                            +{{ daySlot.slots.length - 4 }} more
                          </ion-text>
                        }
                      </div>
                    </div>
                  }
                </div>
              </ion-card-content>
            </ion-card>
          </div>
        }

        @case ('reviews') {
          <div class="reviews-section">
            <ion-card>
              <ion-card-content>
                <div class="reviews-header">
                  <ion-text class="section-title">Patient Reviews</ion-text>
                  @if (doctor.reviews_count) {
                    <ion-text color="medium">({{ doctor.reviews_count }} reviews)</ion-text>
                  }
                </div>

                @if (reviews.length > 0) {
                  <ion-list lines="none">
                    @for (review of reviews; track review.id) {
                      <ion-item class="review-item">
                        <div class="review-content">
                          <div class="review-header">
                            <ion-text class="reviewer-name">{{ review.patient_name }}</ion-text>
                            <div class="rating-stars">
                              @for (star of getRatingStars(review.rating); track $index) {
                                <ion-icon
                                  [name]="star === 1 ? 'star' : 'star-outline'"
                                  color="warning">
                                </ion-icon>
                              }
                            </div>
                          </div>
                          <ion-text class="review-comment">{{ review.comment }}</ion-text>
                          <ion-text class="review-date" color="medium">{{ review.date }}</ion-text>
                        </div>
                      </ion-item>
                    }
                  </ion-list>
                } @else {
                  <div class="no-reviews">
                    <ion-text color="medium">No reviews yet</ion-text>
                  </div>
                }
              </ion-card-content>
            </ion-card>
          </div>
        }
      }
    </div>
  }
</ion-content>
