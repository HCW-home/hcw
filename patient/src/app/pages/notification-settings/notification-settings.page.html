<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/notifications"></ion-back-button>
    </ion-buttons>
    <ion-title>Notification Settings</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="saveSettings()">
        <ion-text color="primary">Save</ion-text>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="notification-settings-content">
  <ion-card class="push-notification-card">
    <ion-item lines="none">
      <ion-icon name="phone-portrait-outline" slot="start" color="primary"></ion-icon>
      <ion-label>
        <ion-text class="setting-title">Push Notifications</ion-text>
        <ion-text class="setting-description" color="medium">
          Receive notifications when app is closed
        </ion-text>
      </ion-label>
      @if (pushPermissionChecking) {
        <ion-spinner name="crescent" slot="end"></ion-spinner>
      } @else {
        <ion-toggle
          [checked]="pushNotificationsEnabled"
          (ionChange)="togglePushNotifications()"
          color="primary">
        </ion-toggle>
      }
    </ion-item>
    @if (pushNotificationsEnabled) {
      <div class="test-notification">
        <ion-button size="small" fill="outline" (click)="testPushNotification()">
          <ion-icon name="notifications-outline" slot="start"></ion-icon>
          Test Notification
        </ion-button>
      </div>
    }
  </ion-card>

  <ion-card class="master-toggle-card">
    <ion-item lines="none">
      <ion-icon name="notifications-outline" slot="start" color="primary"></ion-icon>
      <ion-label>
        <ion-text class="setting-title">All Notifications</ion-text>
        <ion-text class="setting-description" color="medium">
          Master toggle for in-app notifications
        </ion-text>
      </ion-label>
      <ion-toggle
        [(ngModel)]="masterNotifications"
        (ionChange)="toggleMasterNotifications()"
        color="primary">
      </ion-toggle>
    </ion-item>
  </ion-card>

  @if (masterNotifications) {
    <ion-list lines="none">
      <ion-list-header>
        <ion-label>Appointments</ion-label>
      </ion-list-header>
      @for (setting of getNotificationsByCategory('appointments'); track setting.id) {
        <ion-item class="notification-item">
          <ion-icon [name]="setting.icon" slot="start" color="primary"></ion-icon>
          <ion-label>
            <ion-text class="setting-title">{{ setting.title }}</ion-text>
            <ion-text class="setting-description" color="medium">{{ setting.description }}</ion-text>
          </ion-label>
          <ion-toggle
            [(ngModel)]="setting.enabled"
            (ionChange)="toggleNotification(setting)"
            color="primary">
          </ion-toggle>
        </ion-item>
      }

      <ion-card class="reminder-time-card">
        <ion-card-content>
          <ion-text class="reminder-title">Default Reminder Time</ion-text>
          <ion-item lines="none">
            <ion-label>Remind me</ion-label>
            <select [(ngModel)]="selectedReminderTime" (change)="saveSettings()" class="time-select">
              @for (option of reminderOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <ion-list-header>
        <ion-label>Health & Wellness</ion-label>
      </ion-list-header>
      @for (setting of getNotificationsByCategory('health'); track setting.id) {
        <ion-item class="notification-item">
          <ion-icon [name]="setting.icon" slot="start" color="primary"></ion-icon>
          <ion-label>
            <ion-text class="setting-title">{{ setting.title }}</ion-text>
            <ion-text class="setting-description" color="medium">{{ setting.description }}</ion-text>
          </ion-label>
          <ion-toggle
            [(ngModel)]="setting.enabled"
            (ionChange)="toggleNotification(setting)"
            color="primary">
          </ion-toggle>
        </ion-item>
      }

      <ion-list-header>
        <ion-label>Messages</ion-label>
      </ion-list-header>
      @for (setting of getNotificationsByCategory('messages'); track setting.id) {
        <ion-item class="notification-item">
          <ion-icon [name]="setting.icon" slot="start" color="primary"></ion-icon>
          <ion-label>
            <ion-text class="setting-title">{{ setting.title }}</ion-text>
            <ion-text class="setting-description" color="medium">{{ setting.description }}</ion-text>
          </ion-label>
          <ion-toggle
            [(ngModel)]="setting.enabled"
            (ionChange)="toggleNotification(setting)"
            color="primary">
          </ion-toggle>
        </ion-item>
      }

      <ion-list-header>
        <ion-label>Promotions & Updates</ion-label>
      </ion-list-header>
      @for (setting of getNotificationsByCategory('promotions'); track setting.id) {
        <ion-item class="notification-item">
          <ion-icon [name]="setting.icon" slot="start" color="medium"></ion-icon>
          <ion-label>
            <ion-text class="setting-title">{{ setting.title }}</ion-text>
            <ion-text class="setting-description" color="medium">{{ setting.description }}</ion-text>
          </ion-label>
          <ion-toggle
            [(ngModel)]="setting.enabled"
            (ionChange)="toggleNotification(setting)"
            color="primary">
          </ion-toggle>
        </ion-item>
      }
    </ion-list>

    <ion-card class="quiet-hours-card">
      <ion-card-content>
        <ion-item lines="none">
          <ion-icon name="moon-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <ion-text class="setting-title">Quiet Hours</ion-text>
            <ion-text class="setting-description" color="medium">
              Silence notifications during specified hours
            </ion-text>
          </ion-label>
          <ion-toggle
            [(ngModel)]="quietHoursEnabled"
            (ionChange)="toggleQuietHours()"
            color="primary">
          </ion-toggle>
        </ion-item>

        @if (quietHoursEnabled) {
          <div class="time-selection">
            <ion-item lines="none" button (click)="openTimePicker('start')">
              <ion-label>
                <ion-text color="medium">Start Time</ion-text>
              </ion-label>
              <ion-text slot="end" class="time-value">{{ quietHoursStart }}</ion-text>
              <ion-icon name="chevron-forward-outline" slot="end" color="medium"></ion-icon>
            </ion-item>

            <ion-item lines="none" button (click)="openTimePicker('end')">
              <ion-label>
                <ion-text color="medium">End Time</ion-text>
              </ion-label>
              <ion-text slot="end" class="time-value">{{ quietHoursEnd }}</ion-text>
              <ion-icon name="chevron-forward-outline" slot="end" color="medium"></ion-icon>
            </ion-item>
          </div>
        }
      </ion-card-content>
    </ion-card>
  }

  <ion-modal [isOpen]="showTimePicker" (didDismiss)="showTimePicker = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Time</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showTimePicker = false">Done</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-datetime
          presentation="time"
          [value]="timePickerMode === 'start' ? quietHoursStart : quietHoursEnd"
          (ionChange)="onTimeChange($event)">
        </ion-datetime>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
