<div class="consultations-container">
  <div class="header">
    <h1>Consultations</h1>
    <button mat-raised-button color="primary">
      <mat-icon>add</mat-icon>
      New Consultation
    </button>
  </div>

  @if (loading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading consultations...</p>
    </div>
  } @else {
    <mat-card class="consultations-card">
      <mat-card-content>
        <table mat-table [dataSource]="consultations" class="consultations-table">
          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef> ID </th>
            <td mat-cell *matCellDef="let consultation"> #{{ consultation.id }} </td>
          </ng-container>

          <!-- Created Date Column -->
          <ng-container matColumnDef="created_at">
            <th mat-header-cell *matHeaderCellDef> Created </th>
            <td mat-cell *matCellDef="let consultation"> 
              {{ formatDate(consultation.created_at) }}
            </td>
          </ng-container>

          <!-- Beneficiary Column -->
          <ng-container matColumnDef="beneficiary">
            <th mat-header-cell *matHeaderCellDef> Patient </th>
            <td mat-cell *matCellDef="let consultation">
              @if (consultation.beneficiary) {
                <div class="beneficiary-info">
                  <span class="name">{{ consultation.beneficiary.first_name }} {{ consultation.beneficiary.last_name }}</span>
                  <span class="email">{{ consultation.beneficiary.email }}</span>
                </div>
              } @else {
                <span class="no-patient">No patient assigned</span>
              }
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef> Status </th>
            <td mat-cell *matCellDef="let consultation">
              <mat-chip [class]="getStatusClass(consultation)">
                {{ getStatusText(consultation) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Group Column -->
          <ng-container matColumnDef="group">
            <th mat-header-cell *matHeaderCellDef> Group </th>
            <td mat-cell *matCellDef="let consultation">
              @if (consultation.group) {
                <span class="group-name">{{ consultation.group.name }}</span>
              } @else {
                <span class="no-group">Individual</span>
              }
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let consultation">
              <div class="action-buttons">
                <button 
                  mat-button 
                  color="primary" 
                  (click)="openConsultationOverlay(consultation)"
                  class="view-btn">
                  <mat-icon>visibility</mat-icon>
                  View
                </button>
                @if (!consultation.closed_at) {
                  <button 
                    mat-raised-button 
                    color="accent" 
                    (click)="joinConsultation(consultation)"
                    class="join-btn">
                    <mat-icon>videocam</mat-icon>
                    Join
                  </button>
                }
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr 
            mat-row 
            *matRowDef="let consultation; columns: displayedColumns;" 
            class="consultation-row"
            (click)="openConsultationOverlay(consultation)">
          </tr>
        </table>

        @if (consultations.length === 0) {
          <div class="no-consultations">
            <mat-icon class="no-data-icon">medical_services</mat-icon>
            <h3>No Consultations Found</h3>
            <p>You don't have any consultations yet. Create your first consultation to get started.</p>
            <button mat-raised-button color="primary">
              <mat-icon>add</mat-icon>
              Create Consultation
            </button>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }
</div>
