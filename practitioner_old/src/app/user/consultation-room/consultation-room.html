<div class="consultation-room">
  <!-- Header -->
  <mat-toolbar class="consultation-header">
    <div class="consultation-info">
      <mat-icon>medical_services</mat-icon>
      <span>Consultation #{{ consultationId }}</span>
      @if (consultation && consultation.beneficiary?.email) {
        <mat-chip class="participant-chip">{{ consultation.beneficiary.email }}</mat-chip>
      }
    </div>

    <div class="header-actions">
      <button mat-icon-button (click)="toggleChat()" matTooltip="Toggle Chat">
        <mat-icon>{{ chatOpen ? 'chat' : 'chat_bubble_outline' }}</mat-icon>
      </button>
      <button mat-raised-button color="warn" (click)="leaveConsultation()">
        <mat-icon>exit_to_app</mat-icon>
        Leave
      </button>
    </div>
  </mat-toolbar>

  <div class="consultation-content">
    <!-- Video Section -->
    <div class="video-section" [class.chat-open]="chatOpen">
      <div class="video-container">
        <!-- Remote Videos - Dynamic for each participant -->
        <div class="remote-videos-grid">
          @if (!isInCall) {
            <div class="no-video-placeholder">
              <mat-icon>videocam_off</mat-icon>
              <p>Video call not started</p>
            </div>
          } @else {
            @for (remoteStream of remoteStreams | keyvalue; track remoteStream.key) {
              <div class="remote-video-wrapper">
                <video #remoteVideo 
                       autoplay 
                       playsinline 
                       muted="false" 
                       class="remote-video"
                       [id]="'remote-video-' + remoteStream.key"></video>
                <div class="participant-label">
                  {{ getParticipantName(+remoteStream.key) }}
                </div>
              </div>
            }
            @if (remoteStreams.size === 0) {
              <div class="waiting-placeholder">
                <mat-icon>people</mat-icon>
                <p>Waiting for other participants...</p>
              </div>
            }
          }
        </div>

        <!-- Local Video -->
        <div class="local-video-wrapper">
          <video #localVideo autoplay playsinline muted="true" class="local-video"></video>
          @if (isInCall && !isVideoEnabled) {
            <div class="video-disabled-overlay">
              <mat-icon>videocam_off</mat-icon>
            </div>
          }
          <div class="participant-label local">You</div>
        </div>
      </div>

      <!-- Video Controls -->
      <div class="video-controls">
        @if (!isInCall && !isConnecting) {
          <button mat-fab color="primary" (click)="startVideoCall()" matTooltip="Start Video Call">
            <mat-icon>videocam</mat-icon>
          </button>
        } @else if (isConnecting) {
          <button mat-fab color="primary" disabled matTooltip="Connecting...">
            <mat-icon>hourglass_empty</mat-icon>
          </button>
        } @else {
          <div class="control-buttons">
            <button mat-fab
                    [color]="isAudioEnabled ? 'primary' : 'warn'"
                    (click)="toggleAudio()"
                    matTooltip="Toggle Audio">
              <mat-icon>{{ isAudioEnabled ? 'mic' : 'mic_off' }}</mat-icon>
            </button>

            <button mat-fab
                    [color]="isVideoEnabled ? 'primary' : 'warn'"
                    (click)="toggleVideo()"
                    matTooltip="Toggle Video">
              <mat-icon>{{ isVideoEnabled ? 'videocam' : 'videocam_off' }}</mat-icon>
            </button>

            <button mat-fab color="warn" (click)="stopVideoCall()" matTooltip="End Call">
              <mat-icon>call_end</mat-icon>
            </button>
          </div>
        }

        <!-- Participants Info -->
        @if (isInCall) {
          <div class="participants-info">
            <h4>ðŸ‘¥ Participants ({{ participants.length + 1 }})</h4>
            <div class="participant-list">
              <mat-chip class="participant-chip self">
                <mat-icon>person</mat-icon>
                You
              </mat-chip>
              @for (participant of participants; track participant.id) {
                <mat-chip class="participant-chip" [class.publisher]="participant.publisher">
                  <mat-icon>{{ participant.publisher ? 'videocam' : 'visibility' }}</mat-icon>
                  {{ participant.display || 'Participant ' + participant.id }}
                  @if (participant.talking) {
                    <mat-icon class="talking-icon">mic</mat-icon>
                  }
                </mat-chip>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Chat Section -->
    <mat-sidenav-container class="chat-container" [class.chat-closed]="!chatOpen">
      <mat-sidenav-content>
        <!-- This content is hidden when chat is closed -->
      </mat-sidenav-content>

      <mat-sidenav
        mode="side"
        [opened]="chatOpen"
        position="end"
        class="chat-sidenav">

        <div class="chat-header">
          <h3>
            <mat-icon>chat</mat-icon>
            Chat
          </h3>
        </div>

        <div class="chat-content">
          <div class="chat-messages">
            @if (messages.length === 0) {
              <div class="no-messages">
                <mat-icon>chat_bubble_outline</mat-icon>
                <p>No messages yet</p>
              </div>
            }

            @for (message of messages; track message.id) {
              <div class="message"
                   [class.own-message]="message.sender?.id === (authService.currentUser$ | async)?.id">
                <div class="message-header">
                  <span class="sender">{{ message.sender?.email || 'Unknown' }}</span>
                  <span class="time">{{ formatMessageTime(message.created_at) }}</span>
                </div>
                <div class="message-content">{{ message.content }}</div>
              </div>
            }
          </div>

          <mat-divider></mat-divider>

          <div class="message-input">
            <mat-form-field appearance="outline" class="message-field">
              <mat-label>Type a message...</mat-label>
              <input matInput
                     [(ngModel)]="newMessage"
                     (keyup.enter)="sendMessage()"
                     placeholder="Type a message...">
            </mat-form-field>
            <button mat-fab
                    color="primary"
                    (click)="sendMessage()"
                    [disabled]="!newMessage.trim()"
                    class="send-button">
              <mat-icon>send</mat-icon>
            </button>
          </div>
        </div>
      </mat-sidenav>
    </mat-sidenav-container>
  </div>
</div>
