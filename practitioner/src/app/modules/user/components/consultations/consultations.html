<app-page>
  <div class="consultations-container">
    <div class="page-header">
      <div class="search-wrapper">
        <app-input
          placeholder="Search consultations..."
          leftIcon="search"
          [ngModel]="searchQuery"
          (ngModelChange)="onSearchChange($event)">
        </app-input>
      </div>
    </div>

    <div class="consultations-card">
      <app-tabs
        [tabs]="tabItems"
        [activeTab]="activeTab()"
        (tabChange)="setActiveTab($event)">
      </app-tabs>

      <div class="consultations-list">
        @if (loading()) {
          <div class="loading-state">
            <app-loader></app-loader>
            <app-typography [variant]="TypographyTypeEnum['body-regular']" color="var(--slate-500)">
              Loading consultations...
            </app-typography>
          </div>
        } @else if (error()) {
          <div class="error-state">
            <app-svg src="alert-circle" [svgStyle]="{'width.px': 48, 'height.px': 48, 'color': 'var(--rose-500)'}"></app-svg>
            <app-typography [variant]="TypographyTypeEnum['body-l-medium']" color="var(--rose-500)">
              {{ error() }}
            </app-typography>
            <app-button
              text="Retry"
              [size]="ButtonSizeEnum.medium"
              [style]="ButtonStyleEnum.stroke"
              (buttonClick)="retryLoadConsultations()">
            </app-button>
          </div>
        } @else if (consultations().length === 0) {
          <div class="empty-state">
            @if (activeTab() === 'overdue') {
              <app-svg src="alert-circle" [svgStyle]="{'width.px': 48, 'height.px': 48, 'opacity': 0.3}"></app-svg>
              <app-typography [variant]="TypographyTypeEnum['body-l-medium']" color="var(--slate-400)">
                No overdue consultations
              </app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-regular']" color="var(--slate-500)">
                @if (searchQuery) {
                  Try a different search term
                } @else {
                  Consultations requiring attention will appear here
                }
              </app-typography>
            } @else {
              <app-svg src="calendar" [svgStyle]="{'width.px': 48, 'height.px': 48, 'opacity': 0.3}"></app-svg>
              <app-typography [variant]="TypographyTypeEnum['body-l-medium']" color="var(--slate-400)">
                No consultations found
              </app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-regular']" color="var(--slate-500)">
                @if (searchQuery) {
                  Try a different search term
                } @else if (activeTab() === 'active') {
                  Your active consultations will appear here
                } @else {
                  Your completed consultations will appear here
                }
              </app-typography>
            }
          </div>
        } @else {
          @for (consultation of consultations(); track consultation.id) {
            <app-list-item
              [variant]="activeTab() === 'overdue' ? 'overdue' : (activeTab() === 'active' ? 'active' : 'past')"
              [avatarText]="getPatientInitials(consultation)"
              [showOnlineIndicator]="activeTab() === 'active'"
              (itemClick)="viewConsultationDetails(consultation)">
              <div slot="content">
                <app-typography [variant]="TypographyTypeEnum['body-semibold']" color="var(--slate-800)">
                  {{ consultation.title }}
                </app-typography>
                <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)">
                  {{ getBeneficiaryName(consultation) || 'Consultation' }}
                  @if (activeTab() !== 'overdue') {
                    - {{ getConsultationSubtitle(consultation) }}
                  }
                </app-typography>
              </div>
              <div slot="meta">
                @if (activeTab() === 'overdue') {
                  <div class="status-overdue">
                    <app-svg src="alert-circle" [svgStyle]="{'width.px': 16, 'height.px': 16, 'color': 'var(--amber-600)'}"></app-svg>
                    <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="var(--amber-600)">
                      {{ formatDate(consultation.created_at) }}
                    </app-typography>
                  </div>
                } @else if (activeTab() === 'active') {
                  <div class="status-active">
                    <span class="status-dot"></span>
                    <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="var(--primary-600)">
                      Active
                    </app-typography>
                  </div>
                  <app-typography [variant]="TypographyTypeEnum['body-xs-regular']" color="var(--slate-400)">
                    {{ formatDate(consultation.created_at) }}
                  </app-typography>
                } @else {
                  <div class="status-completed">
                    <app-svg src="check" [svgStyle]="{'width.px': 16, 'height.px': 16, 'color': 'var(--emerald-600)'}"></app-svg>
                    <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="var(--emerald-600)">
                      Completed
                    </app-typography>
                  </div>
                  <app-typography [variant]="TypographyTypeEnum['body-xs-regular']" color="var(--slate-400)">
                    {{ formatDate(consultation.closed_at || consultation.created_at) }}
                  </app-typography>
                }
              </div>
              <div slot="action">
                @if (activeTab() === 'overdue') {
                  <button class="action-btn overdue">
                    <span>Review</span>
                  </button>
                } @else {
                  <button class="action-btn" [ngClass]="{'active': activeTab() === 'active', 'past': activeTab() === 'past'}">
                    @if (activeTab() === 'active') {
                      <app-svg src="video" [svgStyle]="{'width.px': 16, 'height.px': 16, 'color': 'var(--White)'}"></app-svg>
                      <span>Resume</span>
                    } @else {
                      <span>View Details</span>
                    }
                  </button>
                }
              </div>
            </app-list-item>
          }
        }
      </div>
    </div>
  </div>
</app-page>
