<app-page>
  <div class="user-profile">
    @if (isLoadingUser()) {
    <div class="loading-container">
      <app-loader></app-loader>
      <span class="loading-text">{{ 'userProfile.loadingProfile' | translate }}</span>
    </div>
    } @else if (user()) {
    <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">
      <div class="profile-card">
        <div class="profile-header-section">
          <input
            #avatarFileInput
            type="file"
            accept="image/*"
            class="file-input-hidden"
            (change)="onAvatarFileSelected($event)" />
          <div class="user-avatar" (click)="openAvatarFilePicker()">
            @if (isUploadingAvatar()) {
            <div class="avatar-loading">
              <span class="avatar-spinner"></span>
            </div>
            } @else if (user()!.picture) {
            <img
              [src]="user()!.picture"
              [alt]="user()!.first_name"
              class="avatar-image" />
            } @else {
            <span class="avatar-initials">{{ getInitials() }}</span>
            }
            <div class="avatar-overlay">
              <app-svg
                src="camera"
                [svgStyle]="{'width.px': 20, 'height.px': 20, 'color': 'white'}"></app-svg>
            </div>
          </div>
          <div class="user-info">
            <h2 class="user-name">
              {{ user()!.first_name }} {{ user()!.last_name }}
            </h2>
            <span class="user-email">{{ user()!.email }}</span>
          </div>
        </div>

        <div class="profile-section">
          <h3 class="section-title">{{ 'userProfile.personalInformation' | translate }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">{{ 'userProfile.firstName' | translate }}</label>
              <input
                type="text"
                class="form-input readonly"
                formControlName="first_name"
                [placeholder]="'userProfile.firstNamePlaceholder' | translate" />
            </div>

            <div class="form-group">
              <label class="form-label">{{ 'userProfile.lastName' | translate }}</label>
              <input
                type="text"
                class="form-input readonly"
                formControlName="last_name"
                [placeholder]="'userProfile.lastNamePlaceholder' | translate" />
            </div>

            <div class="form-group">
              <label class="form-label">{{ 'userProfile.emailAddress' | translate }}</label>
              <input
                type="email"
                class="form-input readonly"
                formControlName="email"
                [placeholder]="'userProfile.emailPlaceholder' | translate" />
            </div>
          </div>
        </div>

        <div class="profile-section">
          <h3 class="section-title">{{ 'userProfile.contactInformation' | translate }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">{{ 'userProfile.mobilePhone' | translate }}</label>
              <input
                type="tel"
                class="form-input"
                formControlName="mobile_phone_number"
                placeholder="+1 234 567 8900" />
            </div>

            <div class="form-group">
              <label class="form-label"
                >{{ 'userProfile.preferredCommunication' | translate }} <span class="required">*</span></label
              >
              <app-select
                formControlName="communication_method"
                [options]="communicationMethods"
                [invalid]="(profileForm.get('communication_method')?.invalid && profileForm.get('communication_method')?.touched) || false"
                [invalidMessage]="'userProfile.communicationMethodRequired' | translate">
              </app-select>
            </div>
          </div>
        </div>

        <div class="profile-section">
          <h3 class="section-title">{{ 'userProfile.preferences' | translate }}</h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label"
                >{{ 'userProfile.timezone' | translate }} <span class="required">*</span></label
              >
              <app-select
                formControlName="timezone"
                [options]="timezoneOptions"
                [invalid]="(profileForm.get('timezone')?.invalid && profileForm.get('timezone')?.touched) || false"
                [invalidMessage]="'userProfile.timezoneRequired' | translate">
              </app-select>
            </div>

            <div class="form-group">
              <label class="form-label">{{ 'userProfile.preferredLanguage' | translate }}</label>
              <app-select
                formControlName="preferred_language"
                [options]="preferredLanguageOptions()"
                [placeholder]="'userProfile.selectPreferredLanguage' | translate">
              </app-select>
            </div>

            <div class="form-group full-width">
              <label class="form-label">{{ 'userProfile.availableLanguages' | translate }}</label>
              <app-select
                formControlName="language_ids"
                [options]="languageOptions()"
                [placeholder]="'userProfile.selectLanguages' | translate"
                [multiSelect]="true">
              </app-select>
            </div>
          </div>
        </div>

        @if (user()!.specialities?.length) {
        <div class="profile-section">
          <h3 class="section-title">{{ 'userProfile.professionalInformation' | translate }}</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="form-label">{{ 'userProfile.specialities' | translate }}</label>
              <div class="badges-list">
                @for (speciality of user()!.specialities; track speciality.id) {
                <app-badge [type]="BadgeTypeEnum.green"
                  >{{ speciality.name }}</app-badge
                >
                }
              </div>
            </div>
          </div>
        </div>
        }

        <div class="form-actions">
          <button class="btn-save" type="submit" [disabled]="isSaving()">
            @if (isSaving()) {
            <span class="btn-loader"></span>
            } {{ 'userProfile.saveChanges' | translate }}
          </button>
        </div>
      </div>
    </form>
    }
  </div>
</app-page>
