<app-page>
  <div class="patients-container">
    <div class="page-header">
      <div class="search-wrapper">
        <app-input
          placeholder="Search patients..."
          leftIcon="search"
          [ngModel]="searchQuery"
          (ngModelChange)="onSearchChange($event)">
        </app-input>
      </div>
      <app-button
        text="Add Patient"
        leftIcon="plus"
        [style]="ButtonStyleEnum.primary"
        [size]="ButtonSizeEnum.small"
        (buttonClick)="openAddModal()">
      </app-button>
    </div>

    <div class="patients-card">
      <app-tabs
        [tabs]="tabItems"
        [activeTab]="activeTab()"
        (tabChange)="setActiveTab($event)">
      </app-tabs>

      <div class="patients-list">
        @if (loading()) {
          <div class="loading-state">
            <app-loader></app-loader>
          </div>
        } @else if (patients().length === 0) {
          <div class="empty-state">
            <app-svg src="user" [svgStyle]="{'width.px': 48, 'height.px': 48, 'color': 'var(--slate-300)'}"></app-svg>
            <app-typography [variant]="TypographyTypeEnum['body-l-medium']" color="var(--slate-600)">
              No patients found
            </app-typography>
            <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-400)">
              @if (searchQuery) {
                Try a different search term
              } @else {
                Add your first patient to get started
              }
            </app-typography>
          </div>
        } @else {
          @for (patient of patients(); track patient.pk) {
            <app-list-item
              [variant]="patient.temporary ? 'temporary' : 'default'"
              [avatarText]="getInitials(patient)"
              [showOnlineIndicator]="patient.is_online ?? false"
              (itemClick)="viewPatient(patient)">
              <div slot="content">
                <app-typography [variant]="TypographyTypeEnum['body-semibold']" color="var(--slate-800)">
                  {{ getFullName(patient) }}
                </app-typography>
                <div class="contact-info">
                  @if (patient.email) {
                    <div class="contact-item">
                      <app-svg src="email" [svgStyle]="{'width.px': 14, 'height.px': 14, 'color': 'var(--slate-400)'}"></app-svg>
                      <span class="contact-text">{{ patient.email }}</span>
                    </div>
                  }
                  @if (patient.mobile_phone_number) {
                    <div class="contact-item">
                      <app-svg src="phone" [svgStyle]="{'width.px': 14, 'height.px': 14, 'color': 'var(--slate-400)'}"></app-svg>
                      <span class="contact-text">{{ patient.mobile_phone_number }}</span>
                    </div>
                  }
                  @if (!patient.email && !patient.mobile_phone_number) {
                    <span class="contact-text no-contact">No contact info</span>
                  }
                </div>
              </div>
              <div slot="meta">
                <app-badge [type]="getOnlineStatusBadgeType(patient.is_online ?? false)">
                  {{ patient.is_online ? 'Online' : 'Offline' }}
                </app-badge>
              </div>
              <div slot="action">
                <div class="row-action">
                  <app-svg src="arrow-right" [svgStyle]="{'width.px': 20, 'height.px': 20, 'color': 'var(--slate-400)'}"></app-svg>
                </div>
              </div>
            </app-list-item>
          }

          @if (hasMore()) {
            <div class="load-more-container">
              <app-button
                text="View More"
                [style]="ButtonStyleEnum.text"
                [size]="ButtonSizeEnum.medium"
                [loading]="loadingMore()"
                [disabled]="loadingMore()"
                (buttonClick)="loadMore()">
              </app-button>
            </div>
          }
        }
      </div>
    </div>
  </div>

  <app-modal
    [isOpen]="showAddModal()"
    size="large"
    [showCloseButton]="false"
    (closed)="closeAddModal()">
    <app-add-edit-patient
      [patient]="null"
      (saved)="onPatientCreated()"
      (cancelled)="closeAddModal()">
    </app-add-edit-patient>
  </app-modal>
</app-page>
