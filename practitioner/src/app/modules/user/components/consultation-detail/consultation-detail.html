<app-page>
  <div class="consultation-detail">
    <div class="consultation-header">
      <app-back-button></app-back-button>

      <div class="header-content">
        <app-typography [variant]="TypographyTypeEnum['h1-bold']">
          Consultation Details
        </app-typography>

        @if (consultation()) {
          <div class="header-actions">
            <app-button
              text="Edit"
              leftIcon="edit"
              [size]="ButtonSizeEnum.medium"
              [style]="ButtonStyleEnum.stroke"
              (buttonClick)="editConsultation()">
            </app-button>

            @if (!consultation()?.closed_at) {
              <app-button
                text="Close Consultation"
                leftIcon="close"
                [size]="ButtonSizeEnum.medium"
                [style]="ButtonStyleEnum.stroke"
                (buttonClick)="closeConsultation()">
              </app-button>
            } @else {
              <app-button
                text="Reopen Consultation"
                leftIcon="refresh"
                [size]="ButtonSizeEnum.medium"
                [style]="ButtonStyleEnum.primary"
                (buttonClick)="reopenConsultation()">
              </app-button>
            }
          </div>
        }
      </div>
    </div>

    @if (isLoadingConsultation()) {
      <div class="loading-container">
        <app-loader></app-loader>
        <app-typography
          [variant]="TypographyTypeEnum['body-regular']"
          color="var(--slate-500)">
          Loading consultation...
        </app-typography>
      </div>
    } @else if (consultation()) {
      <div class="consultation-content-wrapper">
        <div class="main-content">
          <div class="consultation-info-card">
            <div class="info-header">
          <div class="title-section">
            <app-typography [variant]="TypographyTypeEnum['h2-semibold']">
              {{
                consultation()?.title || 'Consultation #' + consultation()?.id
              }}
            </app-typography>
            <div class="consultation-status">
              @if (consultation()?.closed_at) {
                <app-badge [type]="BadgeTypeEnum.red"> Closed </app-badge>
              } @else {
                <app-badge [type]="BadgeTypeEnum.green"> Active </app-badge>
              }
            </div>
          </div>

          <app-typography
            [variant]="TypographyTypeEnum['body-regular']"
            color="var(--slate-500)">
            Created on {{ formatDateTime(consultation()!.created_at) }}
          </app-typography>
        </div>

        @if (consultation()?.description) {
          <div class="description">
            <app-typography [variant]="TypographyTypeEnum['body-regular']">
              {{ consultation()?.description }}
            </app-typography>
          </div>
        }

        <div class="info-grid">
          @if (consultation()?.created_by) {
            <div class="info-item">
              <app-typography
                [variant]="TypographyTypeEnum['body-s-medium']"
                color="var(--slate-500)">
                Created by
              </app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-regular']">
                {{ consultation()!.created_by.first_name }}
                {{ consultation()!.created_by.last_name }}
              </app-typography>
              <app-typography
                [variant]="TypographyTypeEnum['body-s-regular']"
                color="var(--slate-500)">
                {{ consultation()!.created_by.email }}
              </app-typography>
            </div>
          }

          @if (consultation()?.owned_by) {
            <div class="info-item">
              <app-typography
                [variant]="TypographyTypeEnum['body-s-medium']"
                color="var(--slate-500)">
                Owned by
              </app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-regular']">
                {{ consultation()!.owned_by.first_name }}
                {{ consultation()!.owned_by.last_name }}
              </app-typography>
              <app-typography
                [variant]="TypographyTypeEnum['body-s-regular']"
                color="var(--slate-500)">
                {{ consultation()!.owned_by.email }}
              </app-typography>
            </div>
          }

          <div class="info-item">
            <app-typography
              [variant]="TypographyTypeEnum['body-s-medium']"
              color="var(--slate-500)">
              Patient
            </app-typography>
            <app-typography [variant]="TypographyTypeEnum['body-regular']">
              {{ getBeneficiaryDisplayName() }}
            </app-typography>
            @if (consultation()?.beneficiary?.email) {
              <app-typography
                [variant]="TypographyTypeEnum['body-s-regular']"
                color="var(--slate-500)">
                {{ consultation()!.beneficiary!.email }}
              </app-typography>
            }
          </div>

          @if (consultation()?.group) {
            <div class="info-item">
              <app-typography
                [variant]="TypographyTypeEnum['body-s-medium']"
                color="var(--slate-500)">
                Queue
              </app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-regular']">
                {{ consultation()!.group!.name }}
              </app-typography>
            </div>
          }
        </div>
      </div>

      @if (!consultation()?.closed_at) {
        <div class="video-call-section">
          @if (!inCall()) {
            <div class="video-call-invite">
              <div class="invite-content">
                <app-svg
                  src="video"
                  [svgStyle]="{
                    'width.px': 48,
                    'height.px': 48,
                  }"></app-svg>
                <app-typography [variant]="TypographyTypeEnum['h3-semibold']">
                  Video Consultation
                </app-typography>
                <app-typography
                  [variant]="TypographyTypeEnum['body-regular']"
                  color="var(--slate-500)">
                  Start a video call to consult with participants in real-time
                </app-typography>
                <app-button
                  text="Join Video Call"
                  leftIcon="video"
                  [size]="ButtonSizeEnum.large"
                  [style]="ButtonStyleEnum.primary"
                  (buttonClick)="joinVideoCall()">
                </app-button>
              </div>
            </div>
          } @else {
            <app-video-consultation
              [consultationId]="activeAppointmentId() ? undefined : consultationId"
              [appointmentId]="activeAppointmentId() ?? undefined"
              (leave)="onCallEnded()">
            </app-video-consultation>
          }
        </div>
      }

      <div class="tab-content">
        <div class="appointments-section">
          @if (isLoadingAppointments()) {
            <div class="loading-container">
              <app-loader></app-loader>
              <app-typography
                [variant]="TypographyTypeEnum['body-regular']"
                color="var(--slate-500)">
                Loading appointments...
              </app-typography>
            </div>
          } @else {
            <div class="appointments-list">
              <div class="list-header">
                <app-typography [variant]="TypographyTypeEnum['h3-semibold']">
                  Appointments ({{ appointments().length }})
                </app-typography>
              </div>

              @if (appointments().length === 0) {
                <div class="empty-state">
                  <app-svg
                    src="calendar"
                    [svgStyle]="{
                      'width.px': 48,
                      'height.px': 48,
                      opacity: 0.3,
                    }"></app-svg>
                  <app-typography
                    [variant]="TypographyTypeEnum['body-l-medium']"
                    color="var(--slate-400)">
                    No appointments found
                  </app-typography>
                  <app-typography
                    [variant]="TypographyTypeEnum['body-regular']"
                    color="var(--slate-500)">
                    Create an appointment above to get started
                  </app-typography>
                </div>
              } @else {
                <div class="appointments-grid">
                  @for (appointment of appointments(); track appointment.id) {
                    <div
                      class="appointment-card"
                      [class.selected]="
                        selectedAppointment()?.id === appointment.id
                      ">
                      <div class="appointment-header">
                        <div class="appointment-date">
                          <app-svg
                            src="calendar"
                            [svgStyle]="{
                              'width.px': 20,
                              'height.px': 20,
                            }"></app-svg>
                          <app-typography
                            [variant]="TypographyTypeEnum['body-medium']">
                            {{ formatDateTime(appointment.scheduled_at) }}
                          </app-typography>
                        </div>

                        <app-badge
                          [type]="
                            getAppointmentStatusBadgeType(appointment.status)
                          ">
                          {{ appointment.status }}
                        </app-badge>
                      </div>

                      @if (appointment.end_expected_at) {
                        <div class="appointment-end">
                          <app-svg
                            src="schedule"
                            [svgStyle]="{
                              'width.px': 16,
                              'height.px': 16,
                            }"></app-svg>
                          <app-typography
                            [variant]="TypographyTypeEnum['body-s-regular']"
                            color="var(--slate-500)">
                            Expected end:
                            {{ formatDateTime(appointment.end_expected_at) }}
                          </app-typography>
                        </div>
                      }

                      <div class="participants-preview">
                        <app-typography
                          [variant]="TypographyTypeEnum['body-s-medium']"
                          color="var(--slate-500)">
                          Participants: {{ appointment.participants.length }}
                        </app-typography>
                      </div>

                      <div class="appointment-actions">
                        @if (appointment.status === AppointmentStatus.SCHEDULED && appointment.type === 'Online') {
                          <app-button
                            text="Join"
                            leftIcon="video"
                            [size]="ButtonSizeEnum.small"
                            [style]="ButtonStyleEnum.primary"
                            (buttonClick)="joinVideoCall(appointment.id)">
                          </app-button>
                        }

                        <app-button
                          text="Participants"
                          leftIcon="users"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.text"
                          (buttonClick)="selectAppointment(appointment)">
                        </app-button>

                        @if (
                          appointment.status === AppointmentStatus.SCHEDULED
                        ) {
                          <app-button
                            text="Cancel"
                            leftIcon="close"
                            [size]="ButtonSizeEnum.small"
                            [style]="ButtonStyleEnum.stroke"
                            (buttonClick)="cancelAppointment(appointment)">
                          </app-button>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }

          <div class="create-form-card">
            <div class="form-header">
              <app-typography [variant]="TypographyTypeEnum['h3-semibold']">
                Create New Appointment
              </app-typography>
            </div>

            <form
              [formGroup]="appointmentForm"
              (ngSubmit)="createAppointment()"
              class="appointment-form">
              <div class="form-row">
                <app-select
                  label="Appointment Type"
                  formControlName="type"
                  [options]="appointmentTypeOptions"
                  [invalid]="
                    (appointmentForm.get('type')?.invalid &&
                      appointmentForm.get('type')?.touched) ||
                    false
                  "
                  invalidMessage="Appointment type is required"
                  class="full-width">
                </app-select>
              </div>

              <div class="form-row">
                <app-input
                  label="Scheduled Date & Time"
                  type="datetime-local"
                  formControlName="scheduled_at"
                  [invalid]="
                    (appointmentForm.get('scheduled_at')?.invalid &&
                      appointmentForm.get('scheduled_at')?.touched) ||
                    false
                  "
                  invalidMessage="Scheduled date and time is required"
                  placeholder="Select date and time"
                  class="full-width">
                </app-input>
              </div>

              <div class="form-row">
                <app-input
                  label="Expected End Time (Optional)"
                  type="datetime-local"
                  formControlName="end_expected_at"
                  placeholder="Select end time"
                  class="full-width">
                </app-input>
              </div>

              <div class="form-actions">
                <app-button
                  text="Create Appointment"
                  leftIcon="plus"
                  [size]="ButtonSizeEnum.medium"
                  [style]="ButtonStyleEnum.primary"
                  [disabled]="appointmentForm.invalid"
                  [type]="ButtonTypeEnum.submit">
                </app-button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="messages-sidebar">
        <div class="messages-header">
          <app-typography [variant]="TypographyTypeEnum['h3-semibold']">
            Messages
          </app-typography>
        </div>
        <app-message-list
          [messages]="messages()"
          [isConnected]="true"
          (sendMessage)="onSendMessage($event)">
        </app-message-list>
      </div>
    </div>
    }
  </div>
</app-page>
