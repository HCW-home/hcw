<app-page>
  <div class="consultation-detail">
    @if (isLoadingConsultation()) {
      <div class="loading-container">
        <app-loader></app-loader>
        <span class="loading-text">Loading consultation...</span>
      </div>
    } @else if (consultation()) {
      <div class="consultation-content-wrapper">
        <div class="main-content">
          <div class="consultation-info-card">
            @if (isEditMode()) {
              <form [formGroup]="editForm" class="edit-form">
                <div class="edit-form-header">
                  <h3 class="edit-title">Edit Consultation</h3>
                  <div class="edit-actions">
                    <app-button
                      text="Cancel"
                      [style]="ButtonStyleEnum.stroke"
                      [size]="ButtonSizeEnum.small"
                      (buttonClick)="cancelEdit()">
                    </app-button>
                    <app-button
                      text="Save"
                      [style]="ButtonStyleEnum.primary"
                      [size]="ButtonSizeEnum.small"
                      [loading]="isSavingConsultation()"
                      [disabled]="isSavingConsultation()"
                      (buttonClick)="saveConsultationChanges()">
                    </app-button>
                  </div>
                </div>

                <div class="edit-form-content">
                  <div class="form-group">
                    <app-input
                      label="Title"
                      placeholder="Consultation title..."
                      formControlName="title">
                    </app-input>
                  </div>

                  <div class="form-group">
                    <app-textarea
                      label="Description"
                      placeholder="Add description..."
                      [rows]="3"
                      formControlName="description">
                    </app-textarea>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <app-user-search-select
                        label="Beneficary"
                        placeholder="Search patient..."
                        [initialUser]="selectedBeneficiary()"
                        (userSelected)="onBeneficiarySelected($event)">
                      </app-user-search-select>
                    </div>

                    <div class="form-group">
                      <app-user-search-select
                        label="Owner"
                        placeholder="Search owner..."
                        [initialUser]="selectedOwner()"
                        (userSelected)="onOwnerSelected($event)">
                      </app-user-search-select>
                    </div>
                  </div>

                  <div class="form-group">
                    <app-select
                      label="Group"
                      [options]="queueOptions()"
                      placeholder="Select group"
                      [clearable]="true"
                      formControlName="group_id">
                    </app-select>
                  </div>
                </div>
              </form>
            } @else {
              <div class="info-header">
                <div class="header-top-row">
                  <div class="title-row">
                    <h2 class="consultation-title">{{ consultation()?.title || 'Consultation #' + consultation()?.id }}</h2>
                    <app-badge [type]="consultation()?.closed_at ? BadgeTypeEnum.gray : BadgeTypeEnum.green">
                      {{ consultation()?.closed_at ? 'Closed' : 'Active' }}
                    </app-badge>
                  </div>
                  <div class="card-actions">
                    <app-button
                      text="Edit"
                      leftIcon="edit"
                      [style]="ButtonStyleEnum.stroke"
                      [size]="ButtonSizeEnum.small"
                      (buttonClick)="editConsultation()">
                    </app-button>

                    @if (!consultation()?.closed_at) {
                      <app-button
                        text="Close Consultation"
                        leftIcon="close"
                        [style]="ButtonStyleEnum.stroke"
                        [state]="ButtonStateEnum.error"
                        [size]="ButtonSizeEnum.small"
                        (buttonClick)="closeConsultation()">
                      </app-button>
                    } @else {
                      <app-button
                        text="Reopen Consultation"
                        leftIcon="check"
                        [style]="ButtonStyleEnum.primary"
                        [size]="ButtonSizeEnum.small"
                        (buttonClick)="reopenConsultation()">
                      </app-button>
                    }
                  </div>
                </div>
                <span class="created-date">Created on {{ consultation()!.created_at | date: 'longDate' }}</span>
              </div>

              @if (consultation()?.description) {
                <p class="description">{{ consultation()?.description }}</p>
              }

              <div class="info-grid">
                @if (consultation()?.created_by) {
                  <div class="info-item">
                    <span class="info-label">Created by</span>
                    <span class="info-value">{{ consultation()!.created_by.first_name }} {{ consultation()!.created_by.last_name }}</span>
                    <span class="info-sub">{{ consultation()!.created_by.email }}</span>
                  </div>
                }

                @if (consultation()?.owned_by) {
                  <div class="info-item">
                    <span class="info-label">Owned by</span>
                    <span class="info-value">{{ consultation()!.owned_by.first_name }} {{ consultation()!.owned_by.last_name }}</span>
                    <span class="info-sub">{{ consultation()!.owned_by.email }}</span>
                  </div>
                }

                <div class="info-item">
                  <span class="info-label">Patient</span>
                  <span class="info-value">{{ getBeneficiaryDisplayName() }}</span>
                  @if (consultation()?.beneficiary?.email) {
                    <span class="info-sub">{{ consultation()!.beneficiary!.email }}</span>
                  }
                </div>

                @if (consultation()?.group) {
                  <div class="info-item">
                    <span class="info-label">Queue</span>
                    <span class="info-value">{{ consultation()!.group!.name }}</span>
                  </div>
                }
              </div>
            }
          </div>

          @if (inCall() && activeAppointmentId()) {
            <div class="video-call-section" [class.minimized]="isVideoMinimized()">
              <div class="video-container">
                <app-video-consultation
                  [appointmentId]="activeAppointmentId()!"
                  [isMinimized]="isVideoMinimized()"
                  [messages]="messages()"
                  [isLoadingMore]="isLoadingMore()"
                  [hasMore]="hasMore()"
                  (leave)="onCallEnded()"
                  (toggleSize)="toggleVideoSize()"
                  (sendMessage)="onSendMessage($event)"
                  (editMessage)="onEditMessage($event)"
                  (deleteMessage)="onDeleteMessage($event)"
                  (loadMore)="onLoadMore()">
                </app-video-consultation>
              </div>
            </div>
          }

          <div class="appointments-section">
            <div class="section-header">
              <h3 class="section-title">Appointments ({{ appointments().length }})</h3>
              <div class="section-header-actions">
                <div class="view-toggle">
                  <button
                    class="view-toggle-btn"
                    [class.active]="appointmentViewMode() === 'list'"
                    (click)="setAppointmentViewMode('list')">
                    <app-svg src="list" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                    List
                  </button>
                  <button
                    class="view-toggle-btn"
                    [class.active]="appointmentViewMode() === 'calendar'"
                    (click)="setAppointmentViewMode('calendar')">
                    <app-svg src="calendar" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                    Calendar
                  </button>
                </div>
                <div class="status-filter">
                  <button
                    class="filter-btn"
                    [class.active]="appointmentStatusFilter() === 'all'"
                    (click)="setAppointmentStatusFilter('all')">
                    All
                  </button>
                  <button
                    class="filter-btn"
                    [class.active]="appointmentStatusFilter() === AppointmentStatus.SCHEDULED"
                    (click)="setAppointmentStatusFilter('scheduled')">
                    Active
                  </button>
                  <button
                    class="filter-btn"
                    [class.active]="appointmentStatusFilter() === AppointmentStatus.CANCELLED"
                    (click)="setAppointmentStatusFilter('cancelled')">
                    Cancelled
                  </button>
                </div>
                @if (!consultation()?.closed_at) {
                  <app-button
                    text="New Appointment"
                    leftIcon="plus"
                    [size]="ButtonSizeEnum.small"
                    [style]="ButtonStyleEnum.primary"
                    (buttonClick)="openCreateAppointmentModal()">
                  </app-button>
                }
              </div>
            </div>

            @if (isLoadingAppointments()) {
              <div class="loading-container small">
                <app-loader></app-loader>
                <span class="loading-text">Loading appointments...</span>
              </div>
            } @else if (appointments().length === 0) {
              <div class="empty-state">
                <app-svg src="calendar" [svgStyle]="{'width.px': 48, 'height.px': 48, 'opacity': 0.3}"></app-svg>
                <span class="empty-title">No appointments found</span>
                <span class="empty-text">
                  @if (appointmentStatusFilter() !== 'all') {
                    No {{ appointmentStatusFilter() }} appointments
                  } @else {
                    Create an appointment to get started
                  }
                </span>
              </div>
            } @else if (appointmentViewMode() === 'calendar') {
              <div class="calendar-container">
                <div class="calendar-header">
                  <div class="calendar-nav">
                    <button class="nav-btn" (click)="calendarPrev()">
                      <app-svg src="chevron-left" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                    </button>
                    <button class="nav-btn today-btn" (click)="calendarToday()">Today</button>
                    <button class="nav-btn" (click)="calendarNext()">
                      <app-svg src="chevron-right" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                    </button>
                  </div>
                  <span class="calendar-title">{{ getCalendarTitle() }}</span>
                </div>
                <full-calendar
                  #appointmentCalendar
                  [options]="calendarOptions"
                  [events]="calendarEvents()">
                </full-calendar>
              </div>
            } @else {
              <div class="appointments-list">
                @for (appointment of appointments(); track appointment.id) {
                  <div class="appointment-card">
                    <div class="appointment-header">
                      <div class="appointment-info">
                        <div class="date-time">
                          <app-svg src="calendar" [svgStyle]="{'width.px': 18, 'height.px': 18}"></app-svg>
                          <span>{{ appointment.scheduled_at | localDate : 'MMM d, y, HH:mm' }}</span>
                        </div>
                        <span class="appointment-type" [class.online]="appointment.type === AppointmentType.ONLINE">
                          {{ appointment.type }}
                        </span>
                      </div>
                      <app-badge [type]="getAppointmentBadgeType(appointment.status)">
                        {{ appointment.status }}
                      </app-badge>
                    </div>

                    @if (appointment.end_expected_at) {
                      <div class="expected-end">
                        <app-svg src="schedule" [svgStyle]="{'width.px': 14, 'height.px': 14}"></app-svg>
                        <span>Expected end: {{ appointment.end_expected_at | localDate : 'MMM d, y, HH:mm' }}</span>
                      </div>
                    }

                    <div class="participants-section">
                      <span class="participants-label">Participants ({{ appointment.participants.length }})</span>
                      @if (appointment.participants.length) {
                        <div class="participants-list">
                          @for (participant of appointment.participants; track participant.id) {
                            <div class="participant-item">
                              <div class="participant-avatar">
                                {{ getParticipantInitials(participant) }}
                              </div>
                              <div class="participant-details">
                                <span class="participant-name">{{ getUserDisplayName(participant) }}</span>
                                <span class="participant-contact">{{ participant.user?.email || participant.user?.mobile_phone_number || '' }}</span>
                                <div class="participant-meta">
                                  @if (participant.user?.timezone) {
                                    <span class="meta-item">
                                      <app-svg src="clock" [svgStyle]="{'width.px': 12, 'height.px': 12}"></app-svg>
                                      {{ participant.user!.timezone }}
                                    </span>
                                  }
                                  @if (participant.user?.preferred_language) {
                                    <span class="meta-item">
                                      <app-svg src="globe" [svgStyle]="{'width.px': 12, 'height.px': 12}"></app-svg>
                                      {{ getLanguageLabel(participant.user!.preferred_language!) }}
                                    </span>
                                  }
                                  @if (participant.user?.communication_method) {
                                    <span class="meta-item">
                                      <app-svg src="message-square" [svgStyle]="{'width.px': 12, 'height.px': 12}"></app-svg>
                                      {{ participant.user!.communication_method }}
                                    </span>
                                  }
                                </div>
                              </div>
                              <app-badge [type]="getParticipantBadgeType(participant.status)">
                                {{ participant.status }}
                              </app-badge>
                            </div>
                          }
                        </div>
                      } @else {
                        <span class="no-participants">No participants added</span>
                      }
                    </div>

                    <div class="appointment-actions">
                      @if (appointment.status === AppointmentStatus.DRAFT && !consultation()?.closed_at) {
                        <app-button
                          text="Edit"
                          leftIcon="edit"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          (buttonClick)="openEditAppointmentModal(appointment)">
                        </app-button>
                        <app-button
                          text="Send"
                          leftIcon="send"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.primary"
                          (buttonClick)="sendAppointment(appointment)">
                        </app-button>
                        <app-button
                          text="Cancel"
                          leftIcon="close"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          [state]="ButtonStateEnum.error"
                          (buttonClick)="cancelAppointment(appointment)">
                        </app-button>
                      }
                      @if (appointment.status === AppointmentStatus.SCHEDULED && appointment.type === AppointmentType.ONLINE) {
                        <app-button
                          text="Join"
                          leftIcon="video"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.primary"
                          (buttonClick)="joinVideoCall(appointment.id)">
                        </app-button>
                      }
                      @if (appointment.status === AppointmentStatus.SCHEDULED && !consultation()?.closed_at) {
                        <app-button
                          text="Edit"
                          leftIcon="edit"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          (buttonClick)="openEditAppointmentModal(appointment)">
                        </app-button>
                        <app-button
                          text="Cancel"
                          leftIcon="close"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          [state]="ButtonStateEnum.error"
                          (buttonClick)="cancelAppointment(appointment)">
                        </app-button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="messages-sidebar">
          <app-message-list
            [messages]="messages()"
            [isConnected]="true"
            [isLoadingMore]="isLoadingMore()"
            [hasMore]="hasMore()"
            (sendMessage)="onSendMessage($event)"
            (editMessage)="onEditMessage($event)"
            (deleteMessage)="onDeleteMessage($event)"
            (loadMore)="onLoadMore()">
          </app-message-list>
        </div>
      </div>
    }
  </div>

  <app-appointment-form-modal
    [isOpen]="showCreateAppointmentModal()"
    [consultationId]="consultationId"
    [editingAppointment]="editingAppointment()"
    (closed)="closeCreateAppointmentModal()"
    (appointmentCreated)="onAppointmentCreated($event)"
    (appointmentUpdated)="onAppointmentUpdated($event)">
  </app-appointment-form-modal>
</app-page>
