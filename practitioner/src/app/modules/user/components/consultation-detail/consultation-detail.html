<app-page>
  <div class="consultation-detail">
    @if (isLoadingConsultation()) {
      <div class="loading-container">
        <app-loader></app-loader>
        <span class="loading-text">Loading consultation...</span>
      </div>
    } @else if (consultation()) {
      <div class="consultation-content-wrapper">
        <div class="main-content">
          <div class="consultation-info-card">
            <div class="info-header">
              <div class="header-top-row">
                <div class="title-row">
                  <h2 class="consultation-title">{{ consultation()?.title || 'Consultation #' + consultation()?.id }}</h2>
                  <app-badge [type]="consultation()?.closed_at ? BadgeTypeEnum.gray : BadgeTypeEnum.green">
                    {{ consultation()?.closed_at ? 'Closed' : 'Active' }}
                  </app-badge>
                </div>
                <div class="card-actions">
                  <app-button
                    text="Edit"
                    leftIcon="edit"
                    [style]="ButtonStyleEnum.stroke"
                    [size]="ButtonSizeEnum.small"
                    (buttonClick)="editConsultation()">
                  </app-button>

                  @if (!consultation()?.closed_at) {
                    <app-button
                      text="Close Consultation"
                      leftIcon="close"
                      [style]="ButtonStyleEnum.stroke"
                      [state]="ButtonStateEnum.error"
                      [size]="ButtonSizeEnum.small"
                      (buttonClick)="closeConsultation()">
                    </app-button>
                  } @else {
                    <app-button
                      text="Reopen Consultation"
                      leftIcon="check"
                      [style]="ButtonStyleEnum.primary"
                      [size]="ButtonSizeEnum.small"
                      (buttonClick)="reopenConsultation()">
                    </app-button>
                  }
                </div>
              </div>
              <span class="created-date">Created on {{ formatDateTime(consultation()!.created_at) }}</span>
            </div>

            @if (consultation()?.description) {
              <p class="description">{{ consultation()?.description }}</p>
            }

            <div class="info-grid">
              @if (consultation()?.created_by) {
                <div class="info-item">
                  <span class="info-label">Created by</span>
                  <span class="info-value">{{ consultation()!.created_by.first_name }} {{ consultation()!.created_by.last_name }}</span>
                  <span class="info-sub">{{ consultation()!.created_by.email }}</span>
                </div>
              }

              @if (consultation()?.owned_by) {
                <div class="info-item">
                  <span class="info-label">Owned by</span>
                  <span class="info-value">{{ consultation()!.owned_by.first_name }} {{ consultation()!.owned_by.last_name }}</span>
                  <span class="info-sub">{{ consultation()!.owned_by.email }}</span>
                </div>
              }

              <div class="info-item">
                <span class="info-label">Patient</span>
                <span class="info-value">{{ getBeneficiaryDisplayName() }}</span>
                @if (consultation()?.beneficiary?.email) {
                  <span class="info-sub">{{ consultation()!.beneficiary!.email }}</span>
                }
              </div>

              @if (consultation()?.group) {
                <div class="info-item">
                  <span class="info-label">Queue</span>
                  <span class="info-value">{{ consultation()!.group!.name }}</span>
                </div>
              }
            </div>
          </div>

          @if (inCall() && activeAppointmentId()) {
            <div class="video-call-section" [class.minimized]="isVideoMinimized()">
              <div class="video-container">
                <app-video-consultation
                  [appointmentId]="activeAppointmentId()!"
                  [isMinimized]="isVideoMinimized()"
                  (leave)="onCallEnded()"
                  (toggleSize)="toggleVideoSize()">
                </app-video-consultation>
              </div>
            </div>
          }

          <div class="appointments-section">
            <div class="section-header">
              <h3 class="section-title">Appointments ({{ appointments().length }})</h3>
              @if (!consultation()?.closed_at) {
                <app-button
                  text="New Appointment"
                  leftIcon="plus"
                  [size]="ButtonSizeEnum.medium"
                  [style]="ButtonStyleEnum.primary"
                  (buttonClick)="openCreateAppointmentModal()">
                </app-button>
              }
            </div>

            @if (isLoadingAppointments()) {
              <div class="loading-container small">
                <app-loader></app-loader>
                <span class="loading-text">Loading appointments...</span>
              </div>
            } @else if (appointments().length === 0) {
              <div class="empty-state">
                <app-svg src="calendar" [svgStyle]="{'width.px': 48, 'height.px': 48, 'opacity': 0.3}"></app-svg>
                <span class="empty-title">No appointments found</span>
                <span class="empty-text">Create an appointment to get started</span>
              </div>
            } @else {
              <div class="appointments-list">
                @for (appointment of appointments(); track appointment.id) {
                  <div class="appointment-card">
                    <div class="appointment-header">
                      <div class="appointment-info">
                        <div class="date-time">
                          <app-svg src="calendar" [svgStyle]="{'width.px': 18, 'height.px': 18}"></app-svg>
                          <span>{{ formatDateTime(appointment.scheduled_at) }}</span>
                        </div>
                        <span class="appointment-type" [class.online]="appointment.type === 'Online'">
                          {{ appointment.type }}
                        </span>
                      </div>
                      <app-badge [type]="getAppointmentBadgeType(appointment.status)">
                        {{ appointment.status }}
                      </app-badge>
                    </div>

                    @if (appointment.end_expected_at) {
                      <div class="expected-end">
                        <app-svg src="schedule" [svgStyle]="{'width.px': 14, 'height.px': 14}"></app-svg>
                        <span>Expected end: {{ formatDateTime(appointment.end_expected_at) }}</span>
                      </div>
                    }

                    <div class="participants-section">
                      <span class="participants-label">Participants ({{ appointment.participants.length }})</span>
                      @if (appointment.participants.length) {
                        <div class="participants-list">
                          @for (participant of appointment.participants; track participant.id) {
                            <div class="participant-item">
                              <div class="participant-avatar">
                                {{ getParticipantInitials(participant) }}
                              </div>
                              <div class="participant-details">
                                <span class="participant-name">{{ getUserDisplayName(participant) }}</span>
                                <span class="participant-contact">{{ participant.email || participant.phone || '' }}</span>
                              </div>
                              <app-badge [type]="getParticipantBadgeType(participant.status)">
                                {{ participant.status }}
                              </app-badge>
                            </div>
                          }
                        </div>
                      } @else {
                        <span class="no-participants">No participants added</span>
                      }
                    </div>

                    <div class="appointment-actions">
                      @if (appointment.status === AppointmentStatus.DRAFT && !consultation()?.closed_at) {
                        <app-button
                          text="Edit"
                          leftIcon="edit"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          (buttonClick)="openEditAppointmentModal(appointment)">
                        </app-button>
                        <app-button
                          text="Send"
                          leftIcon="send"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.primary"
                          (buttonClick)="sendAppointment(appointment)">
                        </app-button>
                        <app-button
                          text="Manage Participants"
                          leftIcon="users"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          (buttonClick)="openManageParticipantsModal(appointment)">
                        </app-button>
                        <app-button
                          text="Delete"
                          leftIcon="trash"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          [state]="ButtonStateEnum.error"
                          (buttonClick)="deleteAppointment(appointment)">
                        </app-button>
                      }
                      @if (appointment.status === AppointmentStatus.SCHEDULED && appointment.type === 'Online') {
                        <app-button
                          text="Join"
                          leftIcon="video"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.primary"
                          (buttonClick)="joinVideoCall(appointment.id)">
                        </app-button>
                      }
                      @if (appointment.status === AppointmentStatus.SCHEDULED && !consultation()?.closed_at) {
                        <app-button
                          text="Edit"
                          leftIcon="edit"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          (buttonClick)="openEditAppointmentModal(appointment)">
                        </app-button>
                        <app-button
                          text="Manage Participants"
                          leftIcon="users"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          (buttonClick)="openManageParticipantsModal(appointment)">
                        </app-button>
                        <app-button
                          text="Delete"
                          leftIcon="trash"
                          [size]="ButtonSizeEnum.small"
                          [style]="ButtonStyleEnum.stroke"
                          [state]="ButtonStateEnum.error"
                          (buttonClick)="deleteAppointment(appointment)">
                        </app-button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="messages-sidebar">
          <app-message-list
            [messages]="messages()"
            [isConnected]="true"
            [isLoadingMore]="isLoadingMore()"
            [hasMore]="hasMore()"
            (sendMessage)="onSendMessage($event)"
            (editMessage)="onEditMessage($event)"
            (deleteMessage)="onDeleteMessage($event)"
            (loadMore)="onLoadMore()">
          </app-message-list>
        </div>
      </div>
    }
  </div>

  <app-appointment-form-modal
    [isOpen]="showCreateAppointmentModal()"
    [consultationId]="consultationId"
    [editingAppointment]="editingAppointment()"
    (closed)="closeCreateAppointmentModal()"
    (appointmentCreated)="onAppointmentCreated($event)"
    (appointmentUpdated)="onAppointmentUpdated($event)">
  </app-appointment-form-modal>

  <app-manage-participants-modal
    #manageParticipantsModal
    [isOpen]="showManageParticipantsModal()"
    [appointment]="selectedAppointment()"
    (closed)="closeManageParticipantsModal()"
    (participantsChanged)="loadAppointments()">
  </app-manage-participants-modal>
</app-page>
