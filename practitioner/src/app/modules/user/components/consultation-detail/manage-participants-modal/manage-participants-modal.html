<app-modal
  [isOpen]="isOpen"
  title="Manage Participants"
  size="medium"
  (closed)="onClose()">
    <div class="modal-form">
      @if (appointment) {
        <div class="appointment-info-summary">
          <app-svg src="calendar" [svgStyle]="{'width.px': 18, 'height.px': 18}"></app-svg>
          <span>{{ formatDateTime(appointment.scheduled_at) }}</span>
          <span class="appointment-type" [class.online]="appointment.type === AppointmentType.ONLINE">
            {{ appointment.type }}
          </span>
        </div>
      }

      <div class="participants-manage-section">
        <div class="section-header">
          <span class="label">Current Participants ({{ participants().length }})</span>
        </div>

        @if (isLoadingParticipants()) {
          <div class="loading-container small">
            <app-loader></app-loader>
          </div>
        } @else if (participants().length === 0) {
          <div class="empty-participants">
            <span>No participants yet</span>
          </div>
        } @else {
          <div class="participants-manage-list">
            @for (participant of participants(); track participant.id) {
              <div class="participant-manage-item">
                <div class="participant-avatar">
                  {{ getParticipantInitials(participant) }}
                </div>
                <div class="participant-details">
                  <span class="participant-name">{{ getUserDisplayName(participant) }}</span>
                  <span class="participant-contact">{{ participant.email || participant.phone || '' }}</span>
                </div>
                <app-badge [type]="getParticipantBadgeType(participant.status)">
                  {{ participant.status }}
                </app-badge>
                <app-button
                  leftIcon="close"
                  [size]="ButtonSizeEnum.small"
                  [style]="ButtonStyleEnum.text"
                  [state]="ButtonStateEnum.error"
                  (buttonClick)="removeParticipant(participant)">
                </app-button>
              </div>
            }
          </div>
        }
      </div>

      <div class="add-participant-section">
        <div class="section-header">
          <span class="label">Add New Participant</span>
        </div>

        <div class="form-group">
          <label class="form-label">Participant Type</label>
          <div class="type-toggle">
            <button type="button" class="type-btn"
              [class.active]="!isExistingUser()"
              (click)="setParticipantType(false)">
              External Guest
            </button>
            <button type="button" class="type-btn"
              [class.active]="isExistingUser()"
              (click)="setParticipantType(true)">
              Existing User
            </button>
          </div>
        </div>

        <form [formGroup]="participantForm" (ngSubmit)="addParticipant()" class="add-participant-form">
          @if (isExistingUser()) {
            <app-user-search-select
              placeholder="Search by name or email..."
              (userSelected)="onParticipantUserSelected($event)">
            </app-user-search-select>
          } @else {
            <app-input
              type="text"
              label="First Name (Optional)"
              placeholder="First name"
              formControlName="first_name">
            </app-input>

            <app-input
              type="text"
              label="Last Name (Optional)"
              placeholder="Last name"
              formControlName="last_name">
            </app-input>

            <div class="form-group">
              <label class="form-label">Contact Method</label>
              <div class="contact-toggle">
                <button type="button" class="contact-btn" [class.active]="participantForm.get('message_type')?.value === 'email'" (click)="setParticipantMessageType('email')">
                  <app-svg src="mail" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                  Email
                </button>
                <button type="button" class="contact-btn" [class.active]="participantForm.get('message_type')?.value === 'sms'" (click)="setParticipantMessageType('sms')">
                  <app-svg src="phone" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                  Phone
                </button>
              </div>
            </div>

            @if (participantForm.get('message_type')?.value === 'email') {
              <app-input
                type="email"
                label="Email Address"
                placeholder="participant@email.com"
                formControlName="email">
              </app-input>
            } @else {
              <app-input
                type="tel"
                label="Phone Number"
                placeholder="+33 6 12 34 56 78"
                formControlName="phone">
              </app-input>
            }
          }

          <app-button
            text="Add Participant"
            [size]="ButtonSizeEnum.medium"
            [style]="ButtonStyleEnum.primary"
            [disabled]="isAddingParticipant() || (isExistingUser() && !selectedParticipantUser())"
            [loading]="isAddingParticipant()"
            (buttonClick)="addParticipant()">
          </app-button>
        </form>
      </div>

      <div class="modal-actions">
        <app-button
          text="Done"
          [block]="true"
          [size]="ButtonSizeEnum.medium"
          [style]="ButtonStyleEnum.primary"
          (buttonClick)="onClose()">
        </app-button>
      </div>
    </div>
</app-modal>
