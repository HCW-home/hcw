<app-modal
  [isOpen]="isOpen"
  [title]="modalTitle"
  size="medium"
  (closed)="onClose()">
    <form [formGroup]="appointmentForm" class="modal-form">
      <div class="form-group">
        <label class="form-label">Appointment Type <span class="required">*</span></label>
        <div class="type-toggle">
          <button type="button" class="type-btn" [class.active]="appointmentForm.get('type')?.value === 'Online'" (click)="setAppointmentType('Online')">
            <app-svg src="video" [svgStyle]="{'width.px': 18, 'height.px': 18}"></app-svg>
            Online
          </button>
          <button type="button" class="type-btn" [class.active]="appointmentForm.get('type')?.value === 'InPerson'" (click)="setAppointmentType('InPerson')">
            <app-svg src="users" [svgStyle]="{'width.px': 18, 'height.px': 18}"></app-svg>
            In Person
          </button>
        </div>
      </div>

      <div class="form-row">
        <app-input
          type="date"
          label="Date *"
          formControlName="date">
        </app-input>
        <app-input
          type="time"
          label="Time *"
          formControlName="time">
        </app-input>
      </div>

      <app-input
        type="datetime-local"
        label="Expected End Time (Optional)"
        formControlName="end_expected_at">
      </app-input>

      @if (!isEditMode) {
      <div class="participants-form-section" formArrayName="participants">
        <div class="section-header">
          <label class="form-label">Guests</label>
          <button type="button" class="btn-text" (click)="addParticipant()">
            <app-svg src="plus" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
            Add Guest
          </button>
        </div>

        @for (participant of participantsFormArray.controls; track $index; let i = $index) {
          <div class="guest-card" [formGroupName]="i">
            <div class="guest-card-header">
              <span class="guest-number">Guest {{ i + 1 }}</span>
              @if (participantsFormArray.length > 1) {
                <app-button
                  leftIcon="close"
                  [size]="ButtonSizeEnum.small"
                  [style]="ButtonStyleEnum.text"
                  [state]="ButtonStateEnum.error"
                  (buttonClick)="removeParticipant(i)">
                </app-button>
              }
            </div>

            <div class="form-group">
              <label class="form-label">Participant Type</label>
              <div class="type-toggle">
                <button type="button" class="type-btn"
                  [class.active]="!isParticipantExistingUser(i)"
                  (click)="setParticipantType(i, false)">
                  External Guest
                </button>
                <button type="button" class="type-btn"
                  [class.active]="isParticipantExistingUser(i)"
                  (click)="setParticipantType(i, true)">
                  Existing User
                </button>
              </div>
            </div>

            @if (isParticipantExistingUser(i)) {
              <app-user-search-select
                placeholder="Search by name or email..."
                (userSelected)="onParticipantUserSelected(i, $event)">
              </app-user-search-select>
            } @else {
              <app-input
                type="text"
                label="Name (Optional)"
                formControlName="name">
              </app-input>
              <div class="form-group">
                <label class="form-label">Contact Method</label>
                <div class="contact-toggle">
                  <button type="button" class="contact-btn" [class.active]="getParticipantContactType(i) === 'email'" (click)="setParticipantContactType(i, 'email')">
                    <app-svg src="email" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                    Email
                  </button>
                  <button type="button" class="contact-btn" [class.active]="getParticipantContactType(i) === 'phone'" (click)="setParticipantContactType(i, 'phone')">
                    <app-svg src="phone" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                    Phone
                  </button>
                </div>
              </div>
              <app-input
                [type]="getParticipantContactType(i) === 'email' ? 'email' : 'tel'"
                [label]="getParticipantContactType(i) === 'email' ? 'Email Address' : 'Phone Number'"
                [placeholder]="getParticipantContactType(i) === 'email' ? 'guest@email.com' : '+33 6 12 34 56 78'"
                formControlName="email">
              </app-input>
            }
          </div>
        }
      </div>
      }

      <div class="modal-actions">
        <app-button
          text="Cancel"
          [block]="true"
          [size]="ButtonSizeEnum.medium"
          [style]="ButtonStyleEnum.stroke"
          (buttonClick)="onClose()">
        </app-button>
        <app-button
          [text]="submitButtonText"
          [block]="true"
          [size]="ButtonSizeEnum.medium"
          [style]="ButtonStyleEnum.primary"
          [disabled]="appointmentForm.invalid || isSubmitting()"
          [loading]="isSubmitting()"
          (buttonClick)="submit()">
        </app-button>
      </div>
    </form>
</app-modal>
