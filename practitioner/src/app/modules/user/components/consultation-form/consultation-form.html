<app-page>
  <div class="consultation-form-container">
    <app-button
      text="Back to consultations"
      leftIcon="arrow-left"
      [style]="ButtonStyleEnum.text"
      [size]="ButtonSizeEnum.small"
      buttonClass="back-button"
      (buttonClick)="cancel()">
    </app-button>

    @if (isLoading()) {
      <div class="loading-container">
        <app-loader></app-loader>
      </div>
    } @else {
      <app-stepper
        [steps]="stepItems"
        [currentStep]="currentStep()"
        [allowStepClick]="mode === 'edit'"
        (stepChange)="goToStep($event)">
      </app-stepper>

      <form [formGroup]="consultationForm" (ngSubmit)="onSubmit()" class="consultation-form">
        @if (currentStep() === 0) {
          <div class="step-content">
            <div class="form-card">
              <app-typography [variant]="TypographyTypeEnum['body-l-bold']" style="margin-bottom: 24px; display: block;">
                Consultation Details
              </app-typography>

              <div class="form-group">
                <app-user-search-select
                  label="Select Beneficiary"
                  placeholder="Search by name or email..."
                  [temporary]="false"
                  formControlName="beneficiary_id"
                  (userSelected)="onBeneficiarySelected($event)">
                </app-user-search-select>
              </div>

              <div class="form-group">
                <app-input
                  label="Reason"
                  [required]="true"
                  placeholder="e.g., Follow-up consultation, Initial assessment..."
                  formControlName="title"
                  [invalid]="isFieldInvalid('title')"
                  [invalidMessage]="getFieldError('title')">
                </app-input>
              </div>

              <div class="form-group">
                <app-textarea
                  label="Description"
                  placeholder="Add any relevant notes or context for this consultation..."
                  [rows]="4"
                  formControlName="description">
                </app-textarea>
              </div>
            </div>
          </div>
        }

        @if (currentStep() === 1) {
          <div class="step-content">
            <div class="form-card">
              <app-typography [variant]="TypographyTypeEnum['body-l-bold']" style="margin-bottom: 8px; display: block;">
                Owner Assignment
              </app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)" class="step-description">
                Optionally assign this consultation to a team or specific practitioner
              </app-typography>

              <div class="form-group">
                <app-user-search-select
                  label="Select Owner"
                  placeholder="Search by name or email..."
                  [temporary]="false"
                  [hasGroupPermissions]="true"
                  (userSelected)="onOwnerSelected($event)">
                </app-user-search-select>
              </div>

              <div class="form-group">
                <app-select
                  label="Select Group"
                  [options]="queueOptions()"
                  placeholder="Select group"
                  formControlName="group_id">
                </app-select>
              </div>
            </div>
          </div>
        }

        @if (currentStep() === 2) {
          <div class="step-content">
            <div class="step-header">
              <app-typography [variant]="TypographyTypeEnum['body-l-bold']" style="margin-bottom: 8px; display: block;">
                Schedule Appointment
              </app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)" style="display: block;">
                Optional - You can schedule an appointment later from the consultation page
              </app-typography>
            </div>

            <div class="appointments-container" formArrayName="appointments">
              @if (formReady() && appointmentsFormArray && appointmentsFormArray.length > 0) {
                @for (appointment of appointmentsFormArray.controls; track $index; let i = $index) {
                  <div class="form-card appointment-card" [formGroupName]="i">
                    <div class="appointment-header">
                      <app-typography [variant]="TypographyTypeEnum['body-semibold']">
                        Appointment
                        @if (hasAppointmentId(i)) {
                          <span class="saved-badge">(Saved)</span>
                        }
                      </app-typography>
                      <div class="appointment-actions">
                        @if (mode === 'edit') {
                          <app-button
                            [text]="hasAppointmentId(i) ? 'Update' : 'Save'"
                            [style]="ButtonStyleEnum.text"
                            [size]="ButtonSizeEnum.small"
                            [disabled]="isAppointmentSaving(i)"
                            (buttonClick)="saveAppointment(i)">
                          </app-button>
                        }
                        <app-button
                          text="Remove"
                          [style]="ButtonStyleEnum.text"
                          [state]="ButtonStateEnum.error"
                          [size]="ButtonSizeEnum.small"
                          (buttonClick)="removeAppointment(i)">
                        </app-button>
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Appointment Type</label>
                      <div class="type-toggle">
                        <button type="button" class="type-btn"
                          [class.active]="getAppointmentType(i) === AppointmentType.ONLINE"
                          (click)="setAppointmentType(i, AppointmentType.ONLINE)">
                          <app-svg src="video" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                          Online
                        </button>
                        <button type="button" class="type-btn"
                          [class.active]="getAppointmentType(i) === AppointmentType.INPERSON"
                          (click)="setAppointmentType(i, AppointmentType.INPERSON)">
                          <app-svg src="map-pin" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                          In Person
                        </button>
                      </div>
                    </div>

                    <div class="appointment-grid">
                      <div class="form-group">
                        <app-input
                          label="Date"
                          [required]="true"
                          type="date"
                          leftIcon="calendar"
                          formControlName="date">
                        </app-input>
                      </div>
                      <div class="form-group">
                        <app-input
                          label="Time"
                          [required]="true"
                          type="time"
                          leftIcon="clock"
                          formControlName="time">
                        </app-input>
                      </div>
                    </div>

                    @if (mode === 'create') {
                      <div class="invite-flags-section">
                        <div class="invite-flags">
                          <app-checkbox
                            label="Do not invite patient"
                            formControlName="dont_invite_beneficiary">
                          </app-checkbox>
                          <app-checkbox
                            label="Do not invite practitioner"
                            formControlName="dont_invite_practitioner">
                          </app-checkbox>
                          <app-checkbox
                            label="Do not invite me"
                            formControlName="dont_invite_me">
                          </app-checkbox>
                        </div>

                        <div class="invite-preview">
                          <span class="preview-label">Will be invited:</span>
                          <div class="invite-preview-list">
                            @if (getBeneficiaryUser(); as beneficiary) {
                              <div class="preview-item" [class.excluded]="getAppointmentControl(i, 'dont_invite_beneficiary').value">
                                <app-participant-item
                                  [participant]="{id: 0, user: {id: beneficiary.pk, email: beneficiary.email, first_name: beneficiary.first_name, last_name: beneficiary.last_name}, is_active: true}">
                                </app-participant-item>
                                <span class="role-label">Patient</span>
                              </div>
                            }
                            @if (getOwnerUser(); as owner) {
                              <div class="preview-item" [class.excluded]="getAppointmentControl(i, 'dont_invite_practitioner').value">
                                <app-participant-item
                                  [participant]="{id: 0, user: {id: owner.pk, email: owner.email, first_name: owner.first_name, last_name: owner.last_name}, is_active: true}">
                                </app-participant-item>
                                <span class="role-label">Practitioner</span>
                              </div>
                            }
                            @if (getCurrentUserForInvite(); as user) {
                              <div class="preview-item" [class.excluded]="getAppointmentControl(i, 'dont_invite_me').value">
                                <app-participant-item
                                  [participant]="{id: 0, user: {id: user.pk, email: user.email, first_name: user.first_name, last_name: user.last_name}, is_active: true}">
                                </app-participant-item>
                                <span class="role-label">You</span>
                              </div>
                            }
                          </div>
                        </div>
                      </div>
                    }

                    <div class="participants-section" formArrayName="participants">
                      <div class="guest-form">
                        @for (participant of getParticipantsFormArray(i).controls; track $index; let j = $index) {
                          <div class="participant-form" [formGroupName]="j">
                            <div class="participant-header">
                              <span class="participant-number">Participant {{ j + 1 }}</span>
                              <app-button
                                text="Remove"
                                [style]="ButtonStyleEnum.text"
                                [state]="ButtonStateEnum.error"
                                [size]="ButtonSizeEnum.small"
                                (buttonClick)="removeParticipantFromAppointment(i, j)">
                              </app-button>
                            </div>

                            <div class="form-group">
                              <label class="form-label">Participant Type</label>
                              <div class="type-toggle">
                                <button type="button" class="type-btn"
                                  [class.active]="isParticipantExistingUser(i, j)"
                                  (click)="setParticipantType(i, j, true)">
                                  Existing User
                                </button>
                                <button type="button" class="type-btn"
                                  [class.active]="!isParticipantExistingUser(i, j)"
                                  (click)="setParticipantType(i, j, false)">
                                  External Guest
                                </button>
                              </div>
                            </div>

                            @if (isParticipantExistingUser(i, j)) {
                              <div class="form-group">
                                <app-user-search-select
                                  placeholder="Search by name or email..."
                                  (userSelected)="onParticipantUserSelected(i, j, $event)">
                                </app-user-search-select>
                              </div>
                            } @else {
                              <div class="form-group">
                                <label class="form-label">Contact Method</label>
                                <div class="contact-toggle">
                                  <app-button
                                    text="Email"
                                    leftIcon="email"
                                    [block]="true"
                                    [style]="getParticipantContactType(i, j) === 'email' ? ButtonStyleEnum.primary : ButtonStyleEnum.stroke"
                                    [size]="ButtonSizeEnum.small"
                                    (buttonClick)="setParticipantContactType(i, j, 'email')">
                                  </app-button>
                                  <app-button
                                    text="Phone"
                                    leftIcon="phone"
                                    [block]="true"
                                    [style]="getParticipantContactType(i, j) === 'phone' ? ButtonStyleEnum.primary : ButtonStyleEnum.stroke"
                                    [size]="ButtonSizeEnum.small"
                                    (buttonClick)="setParticipantContactType(i, j, 'phone')">
                                  </app-button>
                                </div>
                              </div>

                              <div class="form-group">
                                <app-input
                                  [label]="getParticipantContactType(i, j) === 'email' ? 'Email Address' : 'Phone Number'"
                                  [type]="getParticipantContactType(i, j) === 'email' ? 'email' : 'tel'"
                                  [leftIcon]="getParticipantContactType(i, j) === 'email' ? 'email' : 'phone'"
                                  [placeholder]="getParticipantContactType(i, j) === 'email' ? 'guest@email.com' : '+33 6 12 34 56 78'"
                                  formControlName="email">
                                </app-input>
                              </div>

                              <div class="name-row">
                                <div class="form-group">
                                  <app-input
                                    label="First Name"
                                    leftIcon="user"
                                    placeholder="Enter first name..."
                                    formControlName="first_name">
                                  </app-input>
                                </div>
                                <div class="form-group">
                                  <app-input
                                    label="Last Name"
                                    placeholder="Enter last name..."
                                    formControlName="last_name">
                                  </app-input>
                                </div>
                              </div>

                              <div class="participant-settings">
                                <div class="form-group">
                                  <app-select
                                    label="Timezone"
                                    formControlName="timezone"
                                    [options]="timezoneOptions"
                                    placeholder="Select timezone">
                                  </app-select>
                                </div>
                                <div class="form-group">
                                  <app-select
                                    label="Communication Method"
                                    formControlName="communication_method"
                                    [options]="communicationMethods"
                                    placeholder="Select method">
                                  </app-select>
                                </div>
                                <div class="form-group">
                                  <app-select
                                    label="Preferred Language"
                                    formControlName="preferred_language"
                                    [options]="languageOptions"
                                    placeholder="Select language">
                                  </app-select>
                                </div>
                              </div>
                            }
                          </div>
                        }
                        <app-button
                          text="Add participant"
                          leftIcon="plus"
                          [style]="ButtonStyleEnum.text"
                          [size]="ButtonSizeEnum.small"
                          (buttonClick)="addParticipantToAppointment(i)">
                        </app-button>
                      </div>
                    </div>
                  </div>
                }
              } @else {
                <div class="form-card empty-appointments">
                  <app-button
                    text="Add Appointment"
                    leftIcon="plus"
                    [style]="ButtonStyleEnum.stroke"
                    (buttonClick)="addAppointment()">
                  </app-button>
                  <p class="empty-text">Click to schedule an appointment</p>
                </div>
              }
            </div>
          </div>
        }

        <div class="stepper-actions">
          <app-button
            text="Back"
            leftIcon="arrow-left"
            [style]="ButtonStyleEnum.stroke"
            [size]="ButtonSizeEnum.medium"
            [disabled]="currentStep() === 0"
            (buttonClick)="previousStep()">
          </app-button>

          <div class="action-right">
            @if (mode === 'edit' && isAutoSaving()) {
              <div class="auto-save-indicator">
                <app-svg src="check" [svgStyle]="{'width.px': 16, 'height.px': 16, 'color': 'var(--emerald-500)'}"></app-svg>
                <span>Saving...</span>
              </div>
            }

            @if (currentStep() < 2) {
              <app-button
                text="Next"
                rightIcon="arrow-right"
                [style]="ButtonStyleEnum.primary"
                [size]="ButtonSizeEnum.medium"
                [disabled]="!canProceedToNextStep()"
                (buttonClick)="nextStep()">
              </app-button>
            } @else {
              @if (mode === 'create') {
                <app-button
                  text="Create Consultation"
                  [style]="ButtonStyleEnum.primary"
                  [size]="ButtonSizeEnum.medium"
                  [disabled]="isSaving()"
                  [loading]="isSaving()"
                  (buttonClick)="onSubmit()">
                </app-button>
              } @else {
                <app-button
                  text="Save Changes"
                  [style]="ButtonStyleEnum.primary"
                  [size]="ButtonSizeEnum.medium"
                  [disabled]="isSaving()"
                  [loading]="isSaving()"
                  (buttonClick)="onSubmit()">
                </app-button>
              }
            }
          </div>
        </div>
      </form>
    }
  </div>
</app-page>
