<app-page>
  <div class="test-container">
    <div class="test-header">
      <div class="header-content">
        <div class="title-section">
          <app-typography [variant]="TypographyTypeEnum['h1-semibold']">
            System Test
          </app-typography>
          <app-typography [variant]="TypographyTypeEnum['body-regular']" color="var(--slate-500)">
            Test your audio and video equipment before starting consultations
          </app-typography>
        </div>
        <div class="connection-status">
          <div class="status-dot" [style.background-color]="getConnectionStatusColor()"></div>
          <app-typography
            [variant]="TypographyTypeEnum['body-s-medium']"
            [color]="getConnectionStatusColor()">
            {{getConnectionStatusText()}}
          </app-typography>
        </div>
      </div>
    </div>

    <div class="test-panel">
      <div class="video-section">
        <div class="video-container" [class.active]="cameraStatus() === 'working'">
          <video #videoElement autoplay muted playsinline class="video-element" [class.visible]="cameraStatus() === 'working'"></video>
          @if (cameraStatus() !== 'working') {
            <div class="video-placeholder">
              <div class="placeholder-icon">
                <app-svg src="svg/eye-crossed.svg" [svgStyle]="{'width.px': 64, 'height.px': 64, 'opacity': 0.4}"></app-svg>
              </div>
              <app-typography [variant]="TypographyTypeEnum['body-l-regular']" color="var(--slate-400)">
                {{getCameraPlaceholderText()}}
              </app-typography>
            </div>
          }
        </div>

        <div class="audio-visualizer-bar">
          @for (bar of volumeBars(); track $index) {
            <div class="bar" [style.height.%]="bar + 10" [class.active]="microphoneStatus() === 'working'"></div>
          }
        </div>
      </div>

      <div class="controls-section">
        <div class="test-item">
          <div class="test-item-header">
            <div class="test-icon camera">
              <app-svg src="svg/eye.svg" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
            </div>
            <div class="test-item-info">
              <app-typography [variant]="TypographyTypeEnum['body-medium']">Camera</app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-s-regular']" [color]="cameraStatus() === 'working' ? 'var(--emerald-500)' : cameraStatus() === 'error' ? 'var(--rose-500)' : 'var(--slate-400)'">
                {{getCameraStatusText()}}
              </app-typography>
            </div>
          </div>
          <div class="test-item-action">
            @if (cameraStatus() === 'working') {
              <app-button
                text="Stop"
                [style]="ButtonStyleEnum.stroke"
                [size]="ButtonSizeEnum.small"
                (click)="stopCamera()">
              </app-button>
            } @else {
              <app-button
                [text]="cameraStatus() === 'testing' ? 'Testing...' : 'Test'"
                [style]="ButtonStyleEnum.primary"
                [size]="ButtonSizeEnum.small"
                [disabled]="cameraStatus() === 'testing'"
                (click)="testCamera()">
              </app-button>
            }
          </div>
        </div>

        <div class="test-item">
          <div class="test-item-header">
            <div class="test-icon microphone">
              <app-svg src="svg/report.svg" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
            </div>
            <div class="test-item-info">
              <app-typography [variant]="TypographyTypeEnum['body-medium']">Microphone</app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-s-regular']" [color]="microphoneStatus() === 'working' ? 'var(--emerald-500)' : microphoneStatus() === 'error' ? 'var(--rose-500)' : 'var(--slate-400)'">
                {{getMicrophoneStatusText()}}
              </app-typography>
            </div>
          </div>
          <div class="test-item-action">
            @if (microphoneStatus() === 'working') {
              <app-button
                text="Stop"
                [style]="ButtonStyleEnum.stroke"
                [size]="ButtonSizeEnum.small"
                (click)="stopMicrophone()">
              </app-button>
            } @else {
              <app-button
                [text]="microphoneStatus() === 'testing' ? 'Testing...' : 'Test'"
                [style]="ButtonStyleEnum.primary"
                [size]="ButtonSizeEnum.small"
                [disabled]="microphoneStatus() === 'testing'"
                (click)="testMicrophone()">
              </app-button>
            }
          </div>
        </div>

        <div class="test-item">
          <div class="test-item-header">
            <div class="test-icon speaker">
              <app-svg src="svg/approve.svg" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
            </div>
            <div class="test-item-info">
              <app-typography [variant]="TypographyTypeEnum['body-medium']">Speakers</app-typography>
              <app-typography [variant]="TypographyTypeEnum['body-s-regular']" [color]="speakerStatus() === 'working' ? 'var(--emerald-500)' : speakerStatus() === 'error' ? 'var(--rose-500)' : 'var(--slate-400)'">
                {{getSpeakerStatusText()}}
              </app-typography>
            </div>
          </div>
          <div class="test-item-action">
            @if (speakerStatus() === 'playing') {
              <app-button
                text="I hear it"
                [style]="ButtonStyleEnum['filled-stroke']"
                [size]="ButtonSizeEnum.small"
                (click)="confirmSpeakers()">
              </app-button>
            } @else {
              <app-button
                [text]="speakerStatus() === 'working' ? 'Test Again' : 'Test'"
                [style]="speakerStatus() === 'working' ? ButtonStyleEnum.stroke : ButtonStyleEnum.primary"
                [size]="ButtonSizeEnum.small"
                (click)="testSpeakers()">
              </app-button>
            }
          </div>
        </div>

        <div class="actions-footer">
          @if (allTestsCompleted()) {
            <app-button
              text="Start Consultations"
              [style]="ButtonStyleEnum.primary"
              [size]="ButtonSizeEnum.medium"
              (click)="startConsultations()">
            </app-button>
          } @else {
            <app-button
              text="Test All"
              [style]="ButtonStyleEnum.stroke"
              [size]="ButtonSizeEnum.medium"
              (click)="testAllSystems()">
            </app-button>
          }
        </div>
      </div>
    </div>
  </div>
</app-page>
