<app-page>
  <div class="configuration-page">
    <div class="page-toolbar">
      <div class="connection-status">
        <div class="status-dot" [style.background-color]="getConnectionStatusColor()"></div>
        <span class="status-text">{{ getConnectionStatusText() }}</span>
      </div>
    </div>

    <app-tabs
      [tabs]="tabItems()"
      [activeTab]="activeTab()"
      (tabChange)="setActiveTab($event)">
    </app-tabs>

    <div class="tab-content">
      @if (activeTab() === 'system-test') {
        <div class="system-test-section">
          <div class="test-layout">
            <div class="video-preview-card">
              <div class="card-header">
                <app-svg src="video" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                <span>Camera Preview</span>
              </div>
              <div class="video-container" [class.active]="cameraStatus() === 'working'">
                <video #videoElement autoplay muted playsinline class="video-element" [class.visible]="cameraStatus() === 'working'"></video>
                @if (cameraStatus() !== 'working') {
                  <div class="video-placeholder">
                    <div class="placeholder-icon">
                      <app-svg src="video-off" [svgStyle]="{'width.px': 48, 'height.px': 48}"></app-svg>
                    </div>
                    <span class="placeholder-text">{{ getCameraPlaceholderText() }}</span>
                  </div>
                }
              </div>
              <div class="audio-visualizer">
                @for (bar of volumeBars(); track $index) {
                  <div class="bar" [style.height.%]="bar + 10" [class.active]="microphoneStatus() === 'working'"></div>
                }
              </div>
            </div>

            <div class="test-controls-card">
              <div class="card-header">
                <app-svg src="settings" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                <span>Device Tests</span>
              </div>

              <div class="test-items">
                <div class="test-item">
                  <div class="test-item-icon camera">
                    <app-svg src="video" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                  </div>
                  <div class="test-item-info">
                    <span class="test-item-name">Camera</span>
                    <span class="test-item-status" [class.working]="cameraStatus() === 'working'" [class.error]="cameraStatus() === 'error'">
                      {{ getCameraStatusText() }}
                    </span>
                  </div>
                  <div class="test-item-action">
                    @if (cameraStatus() === 'working') {
                      <app-button text="Stop" [style]="ButtonStyleEnum.stroke" [size]="ButtonSizeEnum.small" (buttonClick)="stopCamera()"></app-button>
                    } @else {
                      <app-button [text]="cameraStatus() === 'testing' ? 'Testing...' : 'Test'" [style]="ButtonStyleEnum.primary" [size]="ButtonSizeEnum.small" [disabled]="cameraStatus() === 'testing'" (buttonClick)="testCamera()"></app-button>
                    }
                  </div>
                </div>

                <div class="test-item">
                  <div class="test-item-icon microphone">
                    <app-svg src="microphone" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                  </div>
                  <div class="test-item-info">
                    <span class="test-item-name">Microphone</span>
                    <span class="test-item-status" [class.working]="microphoneStatus() === 'working'" [class.error]="microphoneStatus() === 'error'">
                      {{ getMicrophoneStatusText() }}
                    </span>
                  </div>
                  <div class="test-item-action">
                    @if (microphoneStatus() === 'working') {
                      <app-button text="Stop" [style]="ButtonStyleEnum.stroke" [size]="ButtonSizeEnum.small" (buttonClick)="stopMicrophone()"></app-button>
                    } @else {
                      <app-button [text]="microphoneStatus() === 'testing' ? 'Testing...' : 'Test'" [style]="ButtonStyleEnum.primary" [size]="ButtonSizeEnum.small" [disabled]="microphoneStatus() === 'testing'" (buttonClick)="testMicrophone()"></app-button>
                    }
                  </div>
                </div>

                <div class="test-item">
                  <div class="test-item-icon speaker">
                    <app-svg src="speaker" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                  </div>
                  <div class="test-item-info">
                    <span class="test-item-name">Speakers</span>
                    <span class="test-item-status" [class.working]="speakerStatus() === 'working'" [class.error]="speakerStatus() === 'error'">
                      {{ getSpeakerStatusText() }}
                    </span>
                  </div>
                  <div class="test-item-action">
                    @if (speakerStatus() === 'playing') {
                      <app-button text="I hear it" [style]="ButtonStyleEnum['filled-stroke']" [size]="ButtonSizeEnum.small" (buttonClick)="confirmSpeakers()"></app-button>
                    } @else {
                      <app-button [text]="speakerStatus() === 'working' ? 'Test Again' : 'Test'" [style]="speakerStatus() === 'working' ? ButtonStyleEnum.stroke : ButtonStyleEnum.primary" [size]="ButtonSizeEnum.small" (buttonClick)="testSpeakers()"></app-button>
                    }
                  </div>
                </div>
              </div>

              <div class="test-actions">
                @if (allTestsCompleted()) {
                  <div class="all-tests-passed">
                    <app-svg src="check" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                    <span>All systems ready</span>
                  </div>
                } @else {
                  <app-button text="Test All Systems" leftIcon="check" [style]="ButtonStyleEnum.stroke" [size]="ButtonSizeEnum.medium" (buttonClick)="testAllSystems()"></app-button>
                }
              </div>
            </div>
          </div>
        </div>
      }

      @if (activeTab() === 'availability') {
        <div class="availability-section">
          @if (isLoading()) {
            <div class="loading-state">
              <app-loader></app-loader>
              <span>Loading availability...</span>
            </div>
          } @else {
            <div class="slots-card">
              <div class="card-header">
                <div class="header-left">
                  <app-svg src="clock" [svgStyle]="{'width.px': 20, 'height.px': 20}"></app-svg>
                  <span>Availability Slots</span>
                </div>
                <app-button text="Add Slot" leftIcon="plus" [size]="ButtonSizeEnum.small" [style]="ButtonStyleEnum.primary" (buttonClick)="openSlotModal('create')"></app-button>
              </div>

              <div class="slots-list">
                @for (slot of bookingSlots(); track slot.id) {
                  <div class="slot-item">
                    <div class="slot-info">
                      <div class="slot-time">{{ getSlotTimeRange(slot) }}</div>
                      <div class="slot-break">Break: {{ getBreakTimeRange(slot) }}</div>
                      <div class="slot-days">
                        @for (day of getActiveDaysForSlot(slot); track day) {
                          <span class="day-tag">{{ day }}</span>
                        } @empty {
                          <span class="no-days">No active days</span>
                        }
                      </div>
                      <div class="slot-validity" [class.infinite]="!slot.valid_until">
                        @if (slot.valid_until) {
                          Valid until: {{ slot.valid_until }}
                        } @else {
                          No expiration
                        }
                      </div>
                    </div>
                    <div class="slot-actions">
                      <app-button
                        leftIcon="edit"
                        [size]="ButtonSizeEnum.small"
                        [style]="ButtonStyleEnum.stroke"
                        [state]="ButtonStateEnum.secondary"
                        (buttonClick)="openSlotModal('edit', slot)">
                      </app-button>
                      <app-button
                        leftIcon="delete"
                        [size]="ButtonSizeEnum.small"
                        [style]="ButtonStyleEnum.stroke"
                        [state]="ButtonStateEnum.error"
                        (buttonClick)="confirmDeleteSlot(slot)">
                      </app-button>
                    </div>
                  </div>
                } @empty {
                  <div class="empty-state">
                    <app-svg src="calendar" [svgStyle]="{'width.px': 48, 'height.px': 48, 'opacity': 0.3}"></app-svg>
                    <span class="empty-title">No availability slots configured</span>
                    <span class="empty-description">Create time slots to define when you are available for appointments</span>
                    <app-button text="Create First Slot" leftIcon="plus" [size]="ButtonSizeEnum.medium" [style]="ButtonStyleEnum.primary" (buttonClick)="openSlotModal('create')"></app-button>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  @if (showSlotModal()) {
    <app-modal>
      <app-slot-modal
        [modalTitle]="modalTitle()"
        [modalMode]="modalMode()"
        [slotForm]="slotForm"
        [weekDays]="weekDays"
        [isSaving]="isSaving()"
        (closeModal)="closeSlotModal()"
        (save)="saveSlot()">
      </app-slot-modal>
    </app-modal>
  }
</app-page>
