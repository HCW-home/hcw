<app-page>
  <div class="dashboard-container">
    @if (loading()) {
      <div class="loading-state">
        <app-loader></app-loader>
        <app-typography [variant]="TypographyTypeEnum['body-regular']" color="var(--slate-500)">
          Loading dashboard...
        </app-typography>
      </div>
    } @else if (error()) {
      <div class="error-state">
        <app-svg src="error" [svgStyle]="{'width.px': 48, 'height.px': 48, 'color': 'var(--rose-500)'}"></app-svg>
        <app-typography [variant]="TypographyTypeEnum['body-l-medium']" color="var(--rose-500)">
          {{ error() }}
        </app-typography>
        <app-button
          text="Retry"
          [size]="ButtonSizeEnum.medium"
          [style]="ButtonStyleEnum.stroke"
          (buttonClick)="retry()">
        </app-button>
      </div>
    } @else {
      @if (hasValidNextAppointment()) {
        <div class="next-appointment-section">
          <div class="section-card highlight">
            <div class="section-header">
              <div class="header-left">
                <div class="section-icon primary">
                  <app-svg src="video" [svgStyle]="{'width.px': 20, 'height.px': 20, 'color': 'var(--primary-600)'}"></app-svg>
                </div>
                <div class="section-title">
                  <app-typography [variant]="TypographyTypeEnum['body-l-bold']" color="var(--slate-800)">
                    Next Appointment
                  </app-typography>
                  <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)">
                    {{ getRelativeTime(nextAppointment()!.scheduled_at!) }}
                  </app-typography>
                </div>
              </div>
              <app-button
                text="Join Now"
                leftIcon="video"
                [size]="ButtonSizeEnum.medium"
                [style]="ButtonStyleEnum.primary"
                (buttonClick)="joinNextAppointment($event)">
              </app-button>
            </div>
            <div class="section-content">
              <div class="next-appointment-card" (click)="viewNextAppointment()">
                <div class="appointment-main">
                  <div class="patient-avatar">
                    <span>--</span>
                  </div>
                  <div class="appointment-info">
                    <app-typography [variant]="TypographyTypeEnum['body-semibold']" color="var(--slate-800)">
                      Appointment
                    </app-typography>
                    <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)">
                      {{ nextAppointment()!.type || 'Online' }}
                    </app-typography>
                  </div>
                </div>
                <div class="appointment-schedule">
                  <app-svg src="calendar" [svgStyle]="{'width.px': 16, 'height.px': 16, 'color': 'var(--slate-400)'}"></app-svg>
                  <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="var(--slate-600)">
                    {{ formatDateTime(nextAppointment()!.scheduled_at!) }}
                  </app-typography>
                </div>
              </div>
            </div>
          </div>
        </div>
      }

      <div class="dashboard-grid">
        <div class="main-content">
          <div class="section-card">
            <div class="section-header">
              <div class="header-left">
                <div class="section-icon primary">
                  <app-svg src="calendar" [svgStyle]="{'width.px': 20, 'height.px': 20, 'color': 'var(--primary-600)'}"></app-svg>
                </div>
                <div class="section-title">
                  <app-typography [variant]="TypographyTypeEnum['body-l-bold']" color="var(--slate-800)">
                    Upcoming Appointments
                  </app-typography>
                  <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)">
                    Your scheduled appointments
                  </app-typography>
                </div>
              </div>
              <app-button
                text="View All"
                [size]="ButtonSizeEnum.small"
                [style]="ButtonStyleEnum.stroke"
                (buttonClick)="navigateToConsultations()">
              </app-button>
            </div>
            <div class="section-content">
              @if (upcomingAppointments().length === 0) {
                <div class="empty-state-small">
                  <app-svg src="calendar" [svgStyle]="{'width.px': 32, 'height.px': 32, 'opacity': 0.3}"></app-svg>
                  <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="var(--slate-400)">
                    No upcoming appointments
                  </app-typography>
                </div>
              } @else {
                <div class="appointments-list">
                  @for (appointment of upcomingAppointments(); track appointment.id) {
                    <div class="appointment-item" (click)="viewAppointment(appointment)">
                      <div class="patient-avatar small">
                        <span>--</span>
                      </div>
                      <div class="appointment-details">
                        <app-typography [variant]="TypographyTypeEnum['body-semibold']" color="var(--slate-800)">
                          {{ getAppointmentTypeLabel(appointment.type) }}
                        </app-typography>
                        <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)">
                          {{ formatDateTime(appointment.scheduled_at) }}
                        </app-typography>
                      </div>
                      <div class="appointment-time">
                        <app-badge [type]="getAppointmentBadgeType(appointment.status)">{{ appointment.status }}</app-badge>
                      </div>
                      @if (appointment.type === AppointmentType.ONLINE) {
                        <div class="video-btn">
                          <app-button
                            text="Join"
                            leftIcon="video"
                            [size]="ButtonSizeEnum.small"
                            [style]="ButtonStyleEnum.primary"
                            (buttonClick)="joinAppointment(appointment, $event)">
                          </app-button>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="overdue-section">
        <div class="section-card overdue">
          <div class="section-header">
            <div class="header-left">
              <div class="section-icon amber">
                <app-svg src="clock" [svgStyle]="{'width.px': 20, 'height.px': 20, 'color': 'var(--amber-600)'}"></app-svg>
              </div>
              <div class="section-title">
                <app-typography [variant]="TypographyTypeEnum['body-l-bold']" color="var(--slate-800)">
                  Overdue Consultations
                </app-typography>
                <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)">
                  Patients awaiting your response
                </app-typography>
              </div>
            </div>
            @if (overdueConsultations().length > 0) {
              <span class="overdue-badge">{{ overdueConsultations().length }} pending</span>
            }
          </div>
          <div class="section-content">
            @if (overdueConsultations().length === 0) {
              <div class="empty-state-small">
                <app-svg src="check" [svgStyle]="{'width.px': 32, 'height.px': 32, 'opacity': 0.3}"></app-svg>
                <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="var(--slate-400)">
                  No overdue consultations
                </app-typography>
              </div>
            } @else {
              <div class="overdue-list">
                @for (consultation of overdueConsultations(); track consultation.id) {
                  <div class="overdue-item" (click)="viewConsultation(consultation)">
                    <div class="patient-avatar amber">
                      <span>{{ getConsultationInitials(consultation) }}</span>
                    </div>
                    <div class="overdue-details">
                      <app-typography [variant]="TypographyTypeEnum['body-semibold']" color="var(--slate-800)">
                        {{ getBeneficiaryName(consultation) }}
                      </app-typography>
                      <app-typography [variant]="TypographyTypeEnum['body-s-regular']" color="var(--slate-500)">
                        {{ consultation.title || 'Consultation' }}
                      </app-typography>
                    </div>
                    <div class="overdue-time">
                      <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="var(--amber-600)">
                        Waiting {{ getWaitingTime(consultation) }}
                      </app-typography>
                    </div>
                    <app-button
                      text="Review"
                      [size]="ButtonSizeEnum.small"
                      [style]="ButtonStyleEnum.primary"
                      buttonClass="review-btn"
                      (buttonClick)="viewConsultation(consultation)">
                    </app-button>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>
</app-page>
