<div class="appointment-form-wrapper">
  <div class="appointment-form-container">
    <div class="appointment-form-section">
      <form [formGroup]="appointmentForm">
        <div class="form-group">
          <label class="form-label">Appointment Type <span class="required">*</span></label>
          <div class="type-toggle">
            <button
              type="button"
              class="type-btn"
              [class.active]="appointmentForm.get('type')?.value === AppointmentType.ONLINE"
              (click)="setAppointmentType(AppointmentType.ONLINE)">
              <app-svg src="video" [svgStyle]="{'width.px': 18, 'height.px': 18}"></app-svg>
              Online
            </button>
            <button
              type="button"
              class="type-btn"
              [class.active]="appointmentForm.get('type')?.value === AppointmentType.INPERSON"
              (click)="setAppointmentType(AppointmentType.INPERSON)">
              <app-svg src="users" [svgStyle]="{'width.px': 18, 'height.px': 18}"></app-svg>
              In Person
            </button>
          </div>
        </div>

        <div class="form-row">
          <app-input
            type="date"
            label="Date"
            [required]="true"
            formControlName="date">
          </app-input>
          <app-input
            type="time"
            label="Time"
            [required]="true"
            formControlName="time">
          </app-input>
        </div>

        <div class="form-row">
          <app-input
            type="date"
            label="Expected End Date"
            formControlName="end_date">
          </app-input>
          <app-input
            type="time"
            label="Expected End Time"
            formControlName="end_time">
          </app-input>
        </div>

        @if (!isEditMode) {
          <div class="invite-flags-section">
            <div class="invite-flags">
              <app-checkbox
                label="Do not invite patient"
                formControlName="dont_invite_beneficiary">
              </app-checkbox>
              <app-checkbox
                label="Do not invite practitioner"
                formControlName="dont_invite_practitioner">
              </app-checkbox>
              <app-checkbox
                label="Do not invite me"
                formControlName="dont_invite_me">
              </app-checkbox>
            </div>
          </div>
        }
      </form>
    </div>

  <div class="participants-section">
    <div class="section-header">
      <span class="section-title">Participants ({{ getTotalParticipantsCount() }})</span>
      <app-button
        [text]="showAddParticipantForm() ? 'Cancel' : 'Add participant'"
        [leftIcon]="showAddParticipantForm() ? 'close' : 'plus'"
        [size]="ButtonSizeEnum.small"
        [style]="ButtonStyleEnum.text"
        (buttonClick)="toggleAddParticipantForm()">
      </app-button>
    </div>

    @if (showAddParticipantForm()) {
      <div class="add-participant-form">
        <div class="form-group">
          <label class="form-label">Participant Type</label>
          <div class="type-toggle compact">
            <button
              type="button"
              class="type-btn"
              [class.active]="isExistingUser()"
              (click)="setParticipantType(true)">
              Existing User
            </button>
            <button
              type="button"
              class="type-btn"
              [class.active]="!isExistingUser()"
              (click)="setParticipantType(false)">
              External Guest
            </button>
          </div>
        </div>

        <form [formGroup]="participantForm">
          @if (isExistingUser()) {
            <div class="form-group">
              <app-user-search-select
                placeholder="Search by name or email..."
                (userSelected)="onParticipantUserSelected($event)">
              </app-user-search-select>
            </div>
          } @else {
            <div class="form-group">
              <label class="form-label">Contact Method</label>
              <div class="contact-toggle">
                <app-button
                  text="Email"
                  leftIcon="email"
                  [block]="true"
                  [style]="participantForm.get('contact_type')?.value === 'email' ? ButtonStyleEnum.primary : ButtonStyleEnum.stroke"
                  [size]="ButtonSizeEnum.small"
                  (buttonClick)="setParticipantMessageType('email')">
                </app-button>
                <app-button
                  text="Phone"
                  leftIcon="phone"
                  [block]="true"
                  [style]="participantForm.get('contact_type')?.value === 'sms' ? ButtonStyleEnum.primary : ButtonStyleEnum.stroke"
                  [size]="ButtonSizeEnum.small"
                  (buttonClick)="setParticipantMessageType('sms')">
                </app-button>
              </div>
            </div>

            @if (participantForm.get('contact_type')?.value === 'email') {
              <div class="form-group">
                <app-input
                  type="email"
                  label="Email Address"
                  leftIcon="email"
                  placeholder="guest@email.com"
                  formControlName="email">
                </app-input>
              </div>
            } @else {
              <div class="form-group">
                <app-input
                  type="tel"
                  label="Phone Number"
                  leftIcon="phone"
                  placeholder="+33 6 12 34 56 78"
                  formControlName="phone">
                </app-input>
              </div>
            }

            <div class="name-row">
              <div class="form-group">
                <app-input
                  type="text"
                  label="First Name"
                  leftIcon="user"
                  placeholder="Enter first name..."
                  formControlName="first_name">
                </app-input>
              </div>
              <div class="form-group">
                <app-input
                  type="text"
                  label="Last Name"
                  placeholder="Enter last name..."
                  formControlName="last_name">
                </app-input>
              </div>
            </div>

            <div class="participant-settings">
              <div class="form-group">
                <app-select
                  label="Timezone"
                  formControlName="timezone"
                  [options]="timezoneOptions"
                  placeholder="Select timezone">
                </app-select>
              </div>
              <div class="form-group">
                <app-select
                  label="Communication Method"
                  formControlName="communication_method"
                  [options]="communicationMethods"
                  placeholder="Select method">
                </app-select>
              </div>
              <div class="form-group">
                <app-select
                  label="Preferred Language"
                  formControlName="preferred_language"
                  [options]="languageOptions"
                  placeholder="Select language">
                </app-select>
              </div>
            </div>
          }

          <app-button
            text="Add participant"
            leftIcon="plus"
            [style]="ButtonStyleEnum.primary"
            [size]="ButtonSizeEnum.small"
            [disabled]="isAddingParticipant() || (isExistingUser() && !selectedParticipantUser())"
            [loading]="isAddingParticipant()"
            (buttonClick)="addParticipant()">
          </app-button>
        </form>
      </div>
    }

    @if (isEditMode && isLoadingParticipants()) {
      <div class="loading-container">
        <app-loader></app-loader>
      </div>
    } @else if (getTotalParticipantsCount() === 0 && !showAddParticipantForm()) {
      <div class="empty-participants">
        <app-svg src="users" [svgStyle]="{'width.px': 32, 'height.px': 32, 'opacity': 0.3}"></app-svg>
        <span>No participants yet</span>
        <span class="empty-hint">Add participants who should join this appointment</span>
      </div>
    } @else if (getTotalParticipantsCount() > 0) {
      <div class="participants-list">
        @for (participant of participants(); track participant.id) {
          <app-participant-item
            [participant]="participant"
            [showRemoveAction]="true"
            (remove)="removeParticipant(participant)">
          </app-participant-item>
        }
        @for (pending of pendingParticipants(); track $index) {
          <app-participant-item
            [pendingParticipant]="pending"
            [isPending]="true"
            [showRemoveAction]="true"
            (remove)="removePendingParticipant($index)">
          </app-participant-item>
        }
      </div>
    }
  </div>
  </div>

  @if (showActions) {
    <div class="form-actions">
      <app-button
        text="Cancel"
        [size]="ButtonSizeEnum.medium"
        [style]="ButtonStyleEnum.stroke"
        (buttonClick)="onCancel()">
      </app-button>
      <app-button
        [text]="submitButtonText"
        [size]="ButtonSizeEnum.medium"
        [style]="ButtonStyleEnum.primary"
        [disabled]="appointmentForm.invalid || isSubmitting()"
        [loading]="isSubmitting()"
        (buttonClick)="submit()">
      </app-button>
    </div>
  }
</div>
