<div class="pre-join-lobby">
  @if (isLoading()) {
    <div class="lobby-loading">
      <app-loader></app-loader>
      <app-typography [variant]="TypographyTypeEnum['body-l-medium']" color="#ffffff">{{ 'preJoinLobby.settingUpDevices' | translate }}</app-typography>
    </div>
  } @else {
    <div class="lobby-content">
      <button class="lobby-close-btn" (click)="onClose()">
        <app-svg src="close" [svgStyle]="{'width.px': 24, 'height.px': 24}"></app-svg>
      </button>
      <div class="lobby-video-section">
        <div class="video-preview-area">
          @if (cameraEnabled() && !permissionDenied()) {
            <video #videoPreview autoplay playsinline muted class="preview-video"></video>
          } @else {
            <div class="camera-off-state">
              <app-svg src="camera-off" [svgStyle]="{'width.px': 56, 'height.px': 56}"></app-svg>
              @if (permissionDenied()) {
                <app-typography [variant]="TypographyTypeEnum['body-l-regular']" color="#f87171">
                  {{ permissionError() }}
                </app-typography>
              } @else {
                <app-typography [variant]="TypographyTypeEnum['body-l-regular']" color="#9ca3af">{{ 'preJoinLobby.cameraOff' | translate }}</app-typography>
              }
            </div>
          }

          <div class="video-overlay-controls">
            <div class="audio-level-container">
              @for (active of getAudioBars(); track $index) {
                <div class="audio-bar" [class.active]="active && microphoneEnabled()"></div>
              }
            </div>

            <div class="toggle-buttons">
              <button
                class="toggle-btn"
                [class.off]="!cameraEnabled()"
                (click)="toggleCamera()"
                [disabled]="permissionDenied()">
                @if (cameraEnabled()) {
                  <app-svg src="camera" [svgStyle]="{'width.px': 22, 'height.px': 22}"></app-svg>
                } @else {
                  <app-svg src="camera-off" [svgStyle]="{'width.px': 22, 'height.px': 22}"></app-svg>
                }
              </button>
              <button
                class="toggle-btn"
                [class.off]="!microphoneEnabled()"
                (click)="toggleMicrophone()"
                [disabled]="permissionDenied()">
                @if (microphoneEnabled()) {
                  <app-svg src="microphone" [svgStyle]="{'width.px': 22, 'height.px': 22}"></app-svg>
                } @else {
                  <app-svg src="microphone-off" [svgStyle]="{'width.px': 22, 'height.px': 22}"></app-svg>
                }
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="lobby-controls-section">
        <app-typography [variant]="TypographyTypeEnum['h3-semibold']" color="#ffffff">{{ 'preJoinLobby.readyToJoin' | translate }}</app-typography>
        <app-typography [variant]="TypographyTypeEnum['body-l-regular']" color="#d1d5db" class="lobby-subtitle">{{ 'preJoinLobby.checkDevices' | translate }}</app-typography>

        <div class="device-selectors">
          @if (cameraOptions.length > 0) {
            <div class="device-row">
              <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="#d1d5db">{{ 'preJoinLobby.camera' | translate }}</app-typography>
              <app-select
                [options]="cameraOptions"
                [ngModel]="selectedCameraId"
                (ngModelChange)="onCameraChange($event)"
                [placeholder]="'preJoinLobby.selectCamera' | translate">
              </app-select>
            </div>
          }

          @if (microphoneOptions.length > 0) {
            <div class="device-row">
              <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="#d1d5db">{{ 'preJoinLobby.microphone' | translate }}</app-typography>
              <app-select
                [options]="microphoneOptions"
                [ngModel]="selectedMicrophoneId"
                (ngModelChange)="onMicrophoneChange($event)"
                [placeholder]="'preJoinLobby.selectMicrophone' | translate">
              </app-select>
            </div>
          }

          @if (speakerSupported && speakerOptions.length > 0) {
            <div class="device-row">
              <app-typography [variant]="TypographyTypeEnum['body-s-medium']" color="#d1d5db">{{ 'preJoinLobby.speaker' | translate }}</app-typography>
              <app-select
                [options]="speakerOptions"
                [ngModel]="selectedSpeakerId"
                (ngModelChange)="onSpeakerChange($event)"
                [placeholder]="'preJoinLobby.selectSpeaker' | translate">
              </app-select>
            </div>
          }
        </div>

        <div class="join-action">
          <app-button
            [text]="'preJoinLobby.joinNow' | translate"
            [style]="ButtonStyleEnum.primary"
            [fullWidth]="true"
            (buttonClick)="onJoin()">
          </app-button>
        </div>
      </div>
    </div>
  }
</div>
