<div class="message-list-container">
  <div class="message-list-header">
    <app-typography [variant]="TypographyTypeEnum['h6-semibold']">Messages</app-typography>
    <span class="connection-status" [class.connected]="isConnected" [class.disconnected]="!isConnected">
      {{ isConnected ? 'Connected' : 'Disconnected' }}
    </span>
  </div>

  <div class="message-list-body">
    @if (messages.length === 0) {
      <div class="no-messages">
        <app-typography [variant]="TypographyTypeEnum['body-regular']">No messages yet</app-typography>
      </div>
    } @else {
      @for (message of messages; track message.id) {
        <div class="message-item" [class.current-user]="message.isCurrentUser" [class.other-user]="!message.isCurrentUser">
          <div class="message-header">
            <app-typography [variant]="TypographyTypeEnum['body-s-semibold']">{{ message.username }}</app-typography>
            <app-typography [variant]="TypographyTypeEnum['body-xs-regular']" class="message-time">
              {{ formatTime(message.timestamp) }}
            </app-typography>
          </div>
          <div class="message-content">
            @if (message.message) {
              <app-typography [variant]="TypographyTypeEnum['body-s-regular']">{{ message.message }}</app-typography>
            }
            @if (message.attachment) {
              @if (isImageAttachment(message.attachment)) {
                @if (getImageUrl(message.id)) {
                  <div class="message-image-attachment" (click)="openImageViewer(message)">
                    <img [src]="getImageUrl(message.id)" [alt]="message.attachment.file_name" class="attachment-image-preview">
                  </div>
                } @else {
                  <div class="message-attachment loading">
                    <app-svg src="image" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                    <span class="attachment-name">Loading image...</span>
                  </div>
                }
              } @else {
                <div class="message-attachment">
                  <app-svg [src]="getAttachmentIcon(message.attachment)" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
                  <span class="attachment-name">{{ message.attachment.file_name }}</span>
                </div>
              }
            }
          </div>
        </div>
      }
    }
  </div>

  @if (selectedFile) {
    <div class="selected-file-preview">
      <app-svg src="paperclip" [svgStyle]="{'width.px': 16, 'height.px': 16}"></app-svg>
      <span class="file-name">{{ selectedFile.name }}</span>
      <app-button
        leftIcon="x"
        [size]="ButtonSizeEnum.small"
        [style]="ButtonStyleEnum.stroke"
        (buttonClick)="removeSelectedFile()">
      </app-button>
    </div>
  }

  <div class="message-list-footer">
    <input
      #fileInput
      type="file"
      class="file-input-hidden"
      (change)="onFileSelected($event)"
    />
    <app-button
      leftIcon="paperclip"
      [size]="ButtonSizeEnum.medium"
      [style]="ButtonStyleEnum.stroke"
      [disabled]="!isConnected"
      (buttonClick)="openFilePicker()">
    </app-button>
    <app-input
      [(ngModel)]="newMessage"
      [placeholder]="'Type a message...'"
      [disabled]="!isConnected"
      (keyup.enter)="onSendMessage()"
    ></app-input>
    <app-button
      text="Send"
      leftIcon="send"
      [size]="ButtonSizeEnum.medium"
      [style]="ButtonStyleEnum.primary"
      [disabled]="(!newMessage.trim() && !selectedFile) || !isConnected"
      (buttonClick)="onSendMessage()">
    </app-button>
  </div>
</div>

<app-modal
  [isOpen]="!!viewingImage()"
  [title]="viewingImage()?.fileName || ''"
  size="large"
  (closed)="closeImageViewer()">
  <img [src]="viewingImage()?.url" [alt]="viewingImage()?.fileName" style="max-width: 100%; max-height: 70vh; display: block; margin: 0 auto;">
</app-modal>
